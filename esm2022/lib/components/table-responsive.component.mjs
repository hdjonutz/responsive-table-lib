import { Component, ContentChild, ContentChildren, EventEmitter, Input, Output } from '@angular/core';
import { IStates, SelectionType } from "./table-responsive-interface";
import { DataTableColumnDirective } from "../directive/column/column.directive";
import { DatatableRowDetailDirective } from "../directive/row-detail/row-detail.directive";
import * as i0 from "@angular/core";
import * as i1 from "./table-header/table-header.component";
import * as i2 from "./table-body/table-body.component";
import * as i3 from "./table-footer/table-footer.component";
export class TableResponsiveComponent {
    constructor() {
        this.selectionType = SelectionType.simple;
        this._internalColumns = [];
        this.HEIGHT_ROW = 50;
        this.filterHeader = [];
        this.sortHeader = [];
        this.pageSize = Infinity;
        this.selected = [];
        this.activate = new EventEmitter();
        this.refreshProp = new EventEmitter();
        this.addItemProp = new EventEmitter();
        this.onChangePositionRows = new EventEmitter();
    }
    ngOnChanges(changes) {
        if (changes['rows']?.currentValue) {
            this.tabledata = [...changes['rows'].currentValue];
            this.tabledataFiltered = [...changes['rows'].currentValue];
            console.log('Table receive data.length:' + this.tabledataFiltered.length);
        }
        if (changes['selected']?.currentValue) {
            this.selected = changes['selected']?.currentValue;
        }
        if (changes['externalFilters']) {
            // console.log('Framework', changes['externalFilters']);
        }
        // console.log('Framework', changes['externalFilters']);
        this.updateFilterInput();
    }
    ngOnInit() {
        this.HEIGHT_HEADER = this.config?.headerHeight ? this.config.headerHeight : this.HEIGHT_HEADER;
        this.HEIGHT_FOOTER = this.config?.footerHeight ? this.config.footerHeight : this.HEIGHT_FOOTER;
        this.HEIGHT_FOOTER = this.config?.rowHeight ? this.config.rowHeight : this.HEIGHT_ROW;
    }
    /**
     * Column templates gathered from `ContentChildren`
     * if described in your markup.
     */
    set columnTemplates(val) {
        this._columnTemplates = val;
        this._internalColumns = val.toArray();
    }
    /**
     * Returns the column templates.
     */
    get columnTemplates() {
        return this._columnTemplates;
    }
    updateFilterInput(keyFilter) {
        this.tabledata = this.rows;
        const sorting = this.config.defaultSorting;
        if (sorting && sorting?.length > 0 && this.rows?.length > 0 && this.filterHeader.length === 0) {
            sorting.map((sort) => {
                const _sort = { direction: sort.direction, key: sort.key, type: sort.type };
                this.sortColumnFilterInput(_sort);
            });
        }
        if (keyFilter) {
            const foundIndex = this.filterHeader.findIndex((f) => f.key === keyFilter.key);
            const type = this._internalColumns.find((f) => f.key === keyFilter.key)?.format;
            if (foundIndex >= 0) {
                // updateFilter from header
                this.filterHeader[foundIndex].value = keyFilter.value;
            }
            else {
                this.filterHeader.push({ key: keyFilter.key, value: keyFilter.value, type: keyFilter.type || type });
            }
        }
        if (this.tabledata) {
            this.filterHeader.forEach((keyValFilter) => {
                this.tabledata = this.tabledata.filter((o) => {
                    let _key = keyValFilter.key + (['DATE', 'DATETIME', 'TIME'].indexOf(keyValFilter.type) >= 0 ? '_toDisplay' : '');
                    const value = o[_key] || o[keyValFilter.key];
                    return (value + '').toLowerCase().indexOf((keyValFilter.value + '').toLowerCase()) >= 0;
                });
            });
        }
        this.tabledataFiltered = this.tabledata;
    }
    sortColumnFilterInput(sort) {
        // performance -> do not call again updateFilterInput reason on original daten;
        this.tabledata = [...this.tabledataFiltered];
        const foundIndex = this.sortHeader.findIndex((f) => f.key === sort.key);
        if (foundIndex >= 0) {
            // updateFilter from header
            this.sortHeader[foundIndex].direction = sort.direction;
        }
        else {
            this.sortHeader.push({ key: sort.key, direction: sort.direction, type: sort.type });
        }
        // this.sortHeader = this.sortHeader.filter((f) => f.direction !== IStates.Nothing);
        // last changed -> last filter has bigger priority
        // let sortByAllKeys = (a: {[key: string]: any}, b: {[key: string]: any}): number => {
        //   const arr: Array<number> = [];
        //   this.sortHeader.forEach((r) => {
        //     const d = r.direction === IStates.BiggerToSmaller ? -1 : 1;
        //     let res = (a[r.key] + '')['localeCompare'](b[r.key] + '', 'de', { numeric: r.type === 'number', sensitivity: "case" });
        //     arr.push(d * res);
        //   });
        //   return  arr.some((s) => s === -1) ? -1 : 1;  // arr[0]; //
        // };
        // last changed -> last filter has smaller priority
        const sortByAllKeys = (a, b) => {
            for (let i = 0; i < this.sortHeader.length; i++) {
                const ky = this.sortHeader[i].key;
                const ty = this.sortHeader[i].type;
                const d = this.sortHeader[i].direction === IStates.Nothing
                    ? 0
                    : this.sortHeader[i].direction === IStates.BiggerToSmaller
                        ? -1
                        : 1;
                const res = (a[ky] + '')['localeCompare'](b[ky] + '', 'de', { numeric: ty === 'number', sensitivity: "case" });
                if (res === -1 || res === 1) {
                    return res * d;
                }
            }
            // the same return 0;
            return 0;
        };
        console.log('before:', this.tabledata);
        if (this.sortHeader.length > 0) {
            this.tabledata = this.tabledata.sort((a, b) => {
                return sortByAllKeys(a, b);
            });
        }
        console.log('after', this.tabledata);
    }
    positionRowsChanged(data) {
        this.tabledata = [...data];
        this.tabledataFiltered = [...data];
        this.onChangePositionRows.emit(data);
    }
    onHeaderSelect(event) { }
    onBodyPage(event) { }
    onSelectRow(rowKeyValuesIndex) {
        this.activate?.emit(rowKeyValuesIndex);
    }
    onBodyScroll(event) { }
    onFooterPage(event) { }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: TableResponsiveComponent, deps: [], target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "16.2.12", type: TableResponsiveComponent, selector: "lib-table-responsive", inputs: { rows: "rows", config: "config", selected: "selected", droggableColumns: "droggableColumns", droggableRows: "droggableRows", externalFilters: "externalFilters" }, outputs: { activate: "activate", refreshProp: "refreshProp", addItemProp: "addItemProp", onChangePositionRows: "onChangePositionRows" }, queries: [{ propertyName: "rowDetail", first: true, predicate: DatatableRowDetailDirective, descendants: true }, { propertyName: "columnTemplates", predicate: DataTableColumnDirective }], usesOnChanges: true, ngImport: i0, template: "<div class=\"responsive_table\">\n\n  <app-table-header\n    [columns]=\"_internalColumns\"\n    [headerHeight]=\"HEIGHT_HEADER\"\n    [allRowsSelected]=\"selected\"\n    [selectionType]=\"selectionType\"\n    [droggableColumns]=\"droggableColumns\"\n    [config]=\"config\"\n    (select)=\"onHeaderSelect($event)\"\n    (onInputTextKey)=\"updateFilterInput($event)\"\n    (onInputSortKey)=\"sortColumnFilterInput($event)\"\n  ></app-table-header>\n  <app-table-body\n    [config]=\"config\"\n    [rows]=\"tabledata\"\n    [scrollbarV]=\"config.scrollV\"\n    [scrollbarH]=\"config.scrollH\"\n    [loadingIndicator]=\"config.showLoading\"\n    [rowCount]=\"tabledataFiltered?.length + ''\"\n    [columns]=\"_internalColumns\"\n    [pageSize]=\"pageSize\"\n    [rowDetail]=\"rowDetail\"\n    [rowClass]=\"rowClass\"\n    [selected]=\"selected\"\n    [droggableRows]=\"droggableRows\"\n    (onChangePositionRows)=\"positionRowsChanged($event)\"\n    (page)=\"onBodyPage($event)\"\n    (select)=\"onSelectRow($event)\"\n    (scroll)=\"onBodyScroll($event)\"\n  ></app-table-body>\n  <app-table-footer\n    [rowCount]=\"tabledataFiltered?.length + ''\"\n    [pageSize]=\"pageSize\"\n    [footerHeight]=\"HEIGHT_FOOTER\"\n    [totalMessage]=\"config.messageTableNoData\"\n    (page)=\"onFooterPage($event)\"\n  ></app-table-footer>\n\n<!--  <div *ngIf=\"config.displayTableName\"> &#45;&#45;NAme&#45;&#45; </div>-->\n\n<!--  <mat-divider></mat-divider>-->\n<!--  <div class=\"responsive_table_header\" style=\"height: {{HEIGHT_HEADER}}\">-->\n<!--    <mat-divider vertical=\"true\"></mat-divider>-->\n<!--    <app-reactive-table-inputs-filter [attr]=\"struct\"-->\n<!--                                      (onInputTextKey)=\"updateFilterInput($event)\"-->\n<!--                                      (onInputSortKey)=\"sortColumnFilterInput($event)\"-->\n<!--                                      (addItem)=\"addItemProp.emit()\"-->\n<!--                                      (refresh)=\"refreshProp.emit()\"-->\n<!--    >-->\n<!--    </app-reactive-table-inputs-filter>-->\n<!--    <mat-divider vertical=\"true\"></mat-divider>-->\n<!--  </div>-->\n\n<!--  <div class=\"responsive_table_header_loading\" *ngIf=\"config?.showLoading && !rows\">-->\n<!--    <mat-divider></mat-divider>-->\n<!--    <mat-progress-bar mode=\"indeterminate\"></mat-progress-bar>-->\n<!--  </div>-->\n\n<!--  <mat-divider></mat-divider>-->\n\n<!--  <div class=\"responsive_table_body\">-->\n<!--    <mat-divider vertical=\"true\"></mat-divider>-->\n<!--    <app-reactive-table-row-cell [data]=\"tabledata\"-->\n<!--                                 [attr]=\"struct\"-->\n<!--                                 (onClickRow)=\"config.onSelectRow($event)\"-->\n<!--                                 [config]=\"config\"-->\n<!--    >-->\n<!--    </app-reactive-table-row-cell>-->\n<!--    <mat-divider vertical=\"true\"></mat-divider>-->\n<!--  </div>-->\n\n<!--  <mat-divider></mat-divider>-->\n<!--  <div *ngIf=\"!config?.displayFooter === false\" class=\"responsive_table_footer\" style=\"height: {{HEIGHT_FOOTER}}\">-->\n<!--    <mat-divider vertical=\"true\"></mat-divider>-->\n<!--    <app-app-reactive-table-footer></app-app-reactive-table-footer>-->\n<!--    <mat-divider vertical=\"true\" style=\"height: 100%\"></mat-divider>-->\n<!--  </div>-->\n<!--  <mat-divider></mat-divider>-->\n</div>\n", styles: [".flex_column,.flex_column_min_width_height,.responsive_table,:host{display:flex;flex:1;flex-direction:column}.flex_row{display:flex;flex:1;flex-direction:row}.max_height_width{height:100%;width:100%;min-width:0;min-height:0}.flex_column_min_width_height,.responsive_table,:host{min-width:0;min-height:0}*{scrollbar-width:thin;scrollbar-color:#5287bd #DFE9EB}*::-webkit-scrollbar{height:10px;width:10px}*::-webkit-scrollbar-track{border-radius:3px;background-color:#d3d8da}*::-webkit-scrollbar-track:hover{background-color:#b8c0c2}*::-webkit-scrollbar-track:active{background-color:#b8c0c2}*::-webkit-scrollbar-thumb{border-radius:3px;background-color:#5287bd}*::-webkit-scrollbar-thumb:hover{background-color:#77a1cb}*::-webkit-scrollbar-thumb:active{background-color:#3d6e9f}.responsive_table{border:1px solid #5287bd}.responsive_table .responsive_table_header{display:flex;background-color:#5287bd;color:#fff}.responsive_table .responsive_table_body{min-width:0;min-height:0;display:flex;flex:1}.responsive_table .responsive_table_footer{display:flex}\n"], dependencies: [{ kind: "component", type: i1.TableHeaderComponent, selector: "app-table-header", inputs: ["columns", "headerHeight", "allRowsSelected", "selectionType", "droggableColumns", "config"], outputs: ["select", "onInputTextKey", "onInputSortKey", "addItem", "refresh"] }, { kind: "component", type: i2.TableBodyComponent, selector: "app-table-body", inputs: ["config", "columns", "rows", "scrollbarV", "scrollbarH", "loadingIndicator", "rowCount", "pageSize", "rowDetail", "rowClass", "selected", "droggableRows"], outputs: ["page", "select", "onChangePositionRows", "scroll"] }, { kind: "component", type: i3.TableFooterComponent, selector: "app-table-footer", inputs: ["rowCount", "pageSize", "footerHeight", "totalMessage"], outputs: ["page"] }] }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: TableResponsiveComponent, decorators: [{
            type: Component,
            args: [{ selector: 'lib-table-responsive', template: "<div class=\"responsive_table\">\n\n  <app-table-header\n    [columns]=\"_internalColumns\"\n    [headerHeight]=\"HEIGHT_HEADER\"\n    [allRowsSelected]=\"selected\"\n    [selectionType]=\"selectionType\"\n    [droggableColumns]=\"droggableColumns\"\n    [config]=\"config\"\n    (select)=\"onHeaderSelect($event)\"\n    (onInputTextKey)=\"updateFilterInput($event)\"\n    (onInputSortKey)=\"sortColumnFilterInput($event)\"\n  ></app-table-header>\n  <app-table-body\n    [config]=\"config\"\n    [rows]=\"tabledata\"\n    [scrollbarV]=\"config.scrollV\"\n    [scrollbarH]=\"config.scrollH\"\n    [loadingIndicator]=\"config.showLoading\"\n    [rowCount]=\"tabledataFiltered?.length + ''\"\n    [columns]=\"_internalColumns\"\n    [pageSize]=\"pageSize\"\n    [rowDetail]=\"rowDetail\"\n    [rowClass]=\"rowClass\"\n    [selected]=\"selected\"\n    [droggableRows]=\"droggableRows\"\n    (onChangePositionRows)=\"positionRowsChanged($event)\"\n    (page)=\"onBodyPage($event)\"\n    (select)=\"onSelectRow($event)\"\n    (scroll)=\"onBodyScroll($event)\"\n  ></app-table-body>\n  <app-table-footer\n    [rowCount]=\"tabledataFiltered?.length + ''\"\n    [pageSize]=\"pageSize\"\n    [footerHeight]=\"HEIGHT_FOOTER\"\n    [totalMessage]=\"config.messageTableNoData\"\n    (page)=\"onFooterPage($event)\"\n  ></app-table-footer>\n\n<!--  <div *ngIf=\"config.displayTableName\"> &#45;&#45;NAme&#45;&#45; </div>-->\n\n<!--  <mat-divider></mat-divider>-->\n<!--  <div class=\"responsive_table_header\" style=\"height: {{HEIGHT_HEADER}}\">-->\n<!--    <mat-divider vertical=\"true\"></mat-divider>-->\n<!--    <app-reactive-table-inputs-filter [attr]=\"struct\"-->\n<!--                                      (onInputTextKey)=\"updateFilterInput($event)\"-->\n<!--                                      (onInputSortKey)=\"sortColumnFilterInput($event)\"-->\n<!--                                      (addItem)=\"addItemProp.emit()\"-->\n<!--                                      (refresh)=\"refreshProp.emit()\"-->\n<!--    >-->\n<!--    </app-reactive-table-inputs-filter>-->\n<!--    <mat-divider vertical=\"true\"></mat-divider>-->\n<!--  </div>-->\n\n<!--  <div class=\"responsive_table_header_loading\" *ngIf=\"config?.showLoading && !rows\">-->\n<!--    <mat-divider></mat-divider>-->\n<!--    <mat-progress-bar mode=\"indeterminate\"></mat-progress-bar>-->\n<!--  </div>-->\n\n<!--  <mat-divider></mat-divider>-->\n\n<!--  <div class=\"responsive_table_body\">-->\n<!--    <mat-divider vertical=\"true\"></mat-divider>-->\n<!--    <app-reactive-table-row-cell [data]=\"tabledata\"-->\n<!--                                 [attr]=\"struct\"-->\n<!--                                 (onClickRow)=\"config.onSelectRow($event)\"-->\n<!--                                 [config]=\"config\"-->\n<!--    >-->\n<!--    </app-reactive-table-row-cell>-->\n<!--    <mat-divider vertical=\"true\"></mat-divider>-->\n<!--  </div>-->\n\n<!--  <mat-divider></mat-divider>-->\n<!--  <div *ngIf=\"!config?.displayFooter === false\" class=\"responsive_table_footer\" style=\"height: {{HEIGHT_FOOTER}}\">-->\n<!--    <mat-divider vertical=\"true\"></mat-divider>-->\n<!--    <app-app-reactive-table-footer></app-app-reactive-table-footer>-->\n<!--    <mat-divider vertical=\"true\" style=\"height: 100%\"></mat-divider>-->\n<!--  </div>-->\n<!--  <mat-divider></mat-divider>-->\n</div>\n", styles: [".flex_column,.flex_column_min_width_height,.responsive_table,:host{display:flex;flex:1;flex-direction:column}.flex_row{display:flex;flex:1;flex-direction:row}.max_height_width{height:100%;width:100%;min-width:0;min-height:0}.flex_column_min_width_height,.responsive_table,:host{min-width:0;min-height:0}*{scrollbar-width:thin;scrollbar-color:#5287bd #DFE9EB}*::-webkit-scrollbar{height:10px;width:10px}*::-webkit-scrollbar-track{border-radius:3px;background-color:#d3d8da}*::-webkit-scrollbar-track:hover{background-color:#b8c0c2}*::-webkit-scrollbar-track:active{background-color:#b8c0c2}*::-webkit-scrollbar-thumb{border-radius:3px;background-color:#5287bd}*::-webkit-scrollbar-thumb:hover{background-color:#77a1cb}*::-webkit-scrollbar-thumb:active{background-color:#3d6e9f}.responsive_table{border:1px solid #5287bd}.responsive_table .responsive_table_header{display:flex;background-color:#5287bd;color:#fff}.responsive_table .responsive_table_body{min-width:0;min-height:0;display:flex;flex:1}.responsive_table .responsive_table_footer{display:flex}\n"] }]
        }], ctorParameters: function () { return []; }, propDecorators: { rows: [{
                type: Input
            }], config: [{
                type: Input
            }], selected: [{
                type: Input
            }], droggableColumns: [{
                type: Input
            }], droggableRows: [{
                type: Input
            }], externalFilters: [{
                type: Input
            }], activate: [{
                type: Output
            }], refreshProp: [{
                type: Output
            }], addItemProp: [{
                type: Output
            }], onChangePositionRows: [{
                type: Output
            }], columnTemplates: [{
                type: ContentChildren,
                args: [DataTableColumnDirective]
            }], rowDetail: [{
                type: ContentChild,
                args: [DatatableRowDetailDirective]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFibGUtcmVzcG9uc2l2ZS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy90YWJsZS1yZXNwb25zaXZlL3NyYy9saWIvY29tcG9uZW50cy90YWJsZS1yZXNwb25zaXZlLmNvbXBvbmVudC50cyIsIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3RhYmxlLXJlc3BvbnNpdmUvc3JjL2xpYi9jb21wb25lbnRzL3RhYmxlLXJlc3BvbnNpdmUuY29tcG9uZW50Lmh0bWwiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLFNBQVMsRUFBRSxZQUFZLEVBQ3ZCLGVBQWUsRUFDZixZQUFZLEVBQ1osS0FBSyxFQUdMLE1BQU0sRUFHUCxNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQXlCLE9BQU8sRUFBVSxhQUFhLEVBQUMsTUFBTSw4QkFBOEIsQ0FBQztBQUNwRyxPQUFPLEVBQUMsd0JBQXdCLEVBQUMsTUFBTSxzQ0FBc0MsQ0FBQztBQUM5RSxPQUFPLEVBQUMsMkJBQTJCLEVBQUMsTUFBTSw4Q0FBOEMsQ0FBQzs7Ozs7QUFPekYsTUFBTSxPQUFPLHdCQUF3QjtJQWdDbkM7UUEvQlUsa0JBQWEsR0FBa0IsYUFBYSxDQUFDLE1BQU0sQ0FBQztRQUU5RCxxQkFBZ0IsR0FBZSxFQUFFLENBQUM7UUFJbEMsZUFBVSxHQUFRLEVBQUUsQ0FBQztRQUlyQixpQkFBWSxHQUE0RCxFQUFFLENBQUM7UUFDM0UsZUFBVSxHQUE4RCxFQUFFLENBQUM7UUFDM0UsYUFBUSxHQUFnRSxRQUFRLENBQUM7UUFNeEUsYUFBUSxHQUFnQixFQUFFLENBQUM7UUFNMUIsYUFBUSxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFFOUIsZ0JBQVcsR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO1FBQ2pDLGdCQUFXLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUNqQyx5QkFBb0IsR0FBNkMsSUFBSSxZQUFZLEVB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QixNQUFNO2dCQUNHLFdBQVc7c0JBQXBCLE1BQU07Z0JBQ0csb0JBQW9CO3NCQUE3QixNQUFNO2dCQWlDSCxlQUFlO3NCQURsQixlQUFlO3VCQUFDLHdCQUF3QjtnQkFPekMsU0FBUztzQkFEUixZQUFZO3VCQUFDLDJCQUEyQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENvbXBvbmVudCwgQ29udGVudENoaWxkLFxuICBDb250ZW50Q2hpbGRyZW4sXG4gIEV2ZW50RW1pdHRlcixcbiAgSW5wdXQsXG4gIE9uQ2hhbmdlcyxcbiAgT25Jbml0LFxuICBPdXRwdXQsXG4gIFF1ZXJ5TGlzdCxcbiAgU2ltcGxlQ2hhbmdlc1xufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7SVJlc3BvbnNpdmVUYWJsZUNvbmZpZywgSVN0YXRlcywgSVR5cGVzLCBTZWxlY3Rpb25UeXBlfSBmcm9tIFwiLi90YWJsZS1yZXNwb25zaXZlLWludGVyZmFjZVwiO1xuaW1wb3J0IHtEYXRhVGFibGVDb2x1bW5EaXJlY3RpdmV9IGZyb20gXCIuLi9kaXJlY3RpdmUvY29sdW1uL2NvbHVtbi5kaXJlY3RpdmVcIjtcbmltcG9ydCB7RGF0YXRhYmxlUm93RGV0YWlsRGlyZWN0aXZlfSBmcm9tIFwiLi4vZGlyZWN0aXZlL3Jvdy1kZXRhaWwvcm93LWRldGFpbC5kaXJlY3RpdmVcIjtcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnbGliLXRhYmxlLXJlc3BvbnNpdmUnLFxuICB0ZW1wbGF0ZVVybDogJy4vdGFibGUtcmVzcG9uc2l2ZS5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL3RhYmxlLXJlc3BvbnNpdmUuY29tcG9uZW50LnNjc3MnXVxufSlcbmV4cG9ydCBjbGFzcyBUYWJsZVJlc3BvbnNpdmVDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uQ2hhbmdlcyB7XG4gIHByb3RlY3RlZCBzZWxlY3Rpb25UeXBlOiBTZWxlY3Rpb25UeXBlID0gU2VsZWN0aW9uVHlwZS5zaW1wbGU7XG5cbiAgX2ludGVybmFsQ29sdW1uczogQXJyYXk8YW55PiA9IFtdO1xuXG4gIEhFSUdIVF9IRUFERVIhOiBudW1iZXI7XG4gIEhFSUdIVF9GT09URVIhOiBudW1iZXI7XG4gIEhFSUdIVF9ST1cgICAgICA9IDUwO1xuXG4gIHRhYmxlZGF0YSE6IEFycmF5PHsgW2tleTogc3RyaW5nXTogYW55IH0+O1xuICB0YWJsZWRhdGFGaWx0ZXJlZCE6IEFycmF5PHsgW2tleTogc3RyaW5nXTogYW55IH0+O1xuICBmaWx0ZXJIZWFkZXI6IEFycmF5PHsga2V5OiBzdHJpbmc7IHZhbHVlOiBzdHJpbmcsIHR5cGU6IHN0cmluZyB9PiAgICAgPSBbXTtcbiAgc29ydEhlYWRlcjogQXJyYXk8eyBrZXk6IHN0cmluZzsgZGlyZWN0aW9uOiBJU3RhdGVzLCB0eXBlOiBJVHlwZXN9PiAgID0gW107XG4gIHBhZ2VTaXplOiBudW1iZXIgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA9IEluZmluaXR5O1xuICAvLyByb3dEZXRhaWwhOiB7a2V5SW5kZXg6IHN0cmluZywgc2hvdzogYm9vbGVhbiwgcm93OiBhbnl9O1xuICByb3dDbGFzcyE6IHtrZXlJbmRleDogc3RyaW5nLCBjbGFzc05hbWU6IGJvb2xlYW4sIHJvdzogYW55fTtcblxuICBASW5wdXQoKSByb3dzITogICAgIEFycmF5PHtba2V5OiBzdHJpbmddOiBhbnl9PjtcbiAgQElucHV0KCkgY29uZmlnITogICBJUmVzcG9uc2l2ZVRhYmxlQ29uZmlnO1xuICBASW5wdXQoKSBzZWxlY3RlZDogIEFycmF5PGFueT4gPSBbXTtcblxuICBASW5wdXQoKSBkcm9nZ2FibGVDb2x1bW5zITogYm9vbGVhbjtcbiAgQElucHV0KCkgZHJvZ2dhYmxlUm93cyE6IGJvb2xlYW47XG4gIEBJbnB1dCgpIGV4dGVybmFsRmlsdGVycyE6IHtba2V5OiBzdHJpbmddOiBhbnl9O1xuXG4gIEBPdXRwdXQoKSBhY3RpdmF0ZSA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICBAT3V0cHV0KCkgcmVmcmVzaFByb3AgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIEBPdXRwdXQoKSBhZGRJdGVtUHJvcCA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgQE91dHB1dCgpIG9uQ2hhbmdlUG9zaXRpb25Sb3dzOiBFdmVudEVtaXR0ZXI8QXJyYXk8e1trZXk6c3RyaW5nXTogYW55fT4+ID0gbmV3IEV2ZW50RW1pdHRlcjxBcnJheTx7W3A6IHN0cmluZ106IGFueX0+PigpO1xuXG4gIF9jb2x1bW5UZW1wbGF0ZXMhOiBRdWVyeUxpc3Q8RGF0YVRhYmxlQ29sdW1uRGlyZWN0aXZlPjtcbiAgY29uc3RydWN0b3IoKSB7fVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpOiB2b2lkIHtcbiAgICBpZiAoY2hhbmdlc1sncm93cyddPy5jdXJyZW50VmFsdWUpIHtcbiAgICAgIHRoaXMudGFibGVkYXRhID0gICAgICAgICAgWy4uLmNoYW5nZXNbJ3Jvd3MnXS5jdXJyZW50VmFsdWVdO1xuICAgICAgdGhpcy50YWJsZWRhdGFGaWx0ZXJlZCA9ICBbLi4uY2hhbmdlc1sncm93cyddLmN1cnJlbnRWYWx1ZV07XG4gICAgICBjb25zb2xlLmxvZygnVGFibGUgcmVjZWl2ZSBkYXRhLmxlbmd0aDonICArdGhpcy50YWJsZWRhdGFGaWx0ZXJlZC5sZW5ndGgpO1xuICAgIH1cbiAgICBpZiAoY2hhbmdlc1snc2VsZWN0ZWQnXT8uY3VycmVudFZhbHVlKSB7XG4gICAgICB0aGlzLnNlbGVjdGVkID0gY2hhbmdlc1snc2VsZWN0ZWQnXT8uY3VycmVudFZhbHVlO1xuICAgIH1cbiAgICBpZiAoY2hhbmdlc1snZXh0ZXJuYWxGaWx0ZXJzJ10pIHtcbiAgICAgIC8vIGNvbnNvbGUubG9nKCdGcmFtZXdvcmsnLCBjaGFuZ2VzWydleHRlcm5hbEZpbHRlcnMnXSk7XG4gICAgfVxuICAgIC8vIGNvbnNvbGUubG9nKCdGcmFtZXdvcmsnLCBjaGFuZ2VzWydleHRlcm5hbEZpbHRlcnMnXSk7XG5cbiAgICB0aGlzLnVwZGF0ZUZpbHRlcklucHV0KCk7XG4gIH1cblxuICBuZ09uSW5pdCgpOiB2b2lkIHtcbiAgICB0aGlzLkhFSUdIVF9IRUFERVIgPSB0aGlzLmNvbmZpZz8uaGVhZGVySGVpZ2h0ID8gdGhpcy5jb25maWcuaGVhZGVySGVpZ2h0IDogdGhpcy5IRUlHSFRfSEVBREVSO1xuICAgIHRoaXMuSEVJR0hUX0ZPT1RFUiA9IHRoaXMuY29uZmlnPy5mb290ZXJIZWlnaHQgPyB0aGlzLmNvbmZpZy5mb290ZXJIZWlnaHQgOiB0aGlzLkhFSUdIVF9GT09URVI7XG4gICAgdGhpcy5IRUlHSFRfRk9PVEVSID0gdGhpcy5jb25maWc/LnJvd0hlaWdodCA/IHRoaXMuY29uZmlnLnJvd0hlaWdodCA6IHRoaXMuSEVJR0hUX1JPVztcbiAgfVxuXG4gIC8qKlxuICAgKiBDb2x1bW4gdGVtcGxhdGVzIGdhdGhlcmVkIGZyb20gYENvbnRlbnRDaGlsZHJlbmBcbiAgICogaWYgZGVzY3JpYmVkIGluIHlvdXIgbWFya3VwLlxuICAgKi9cbiAgQENvbnRlbnRDaGlsZHJlbihEYXRhVGFibGVDb2x1bW5EaXJlY3RpdmUpXG4gIHNldCBjb2x1bW5UZW1wbGF0ZXModmFsOiBRdWVyeUxpc3Q8RGF0YVRhYmxlQ29sdW1uRGlyZWN0aXZlPikge1xuICAgIHRoaXMuX2NvbHVtblRlbXBsYXRlcyA9IHZhbDtcbiAgICB0aGlzLl9pbnRlcm5hbENvbHVtbnMgPSB2YWwudG9BcnJheSgpO1xuICB9XG5cbiAgQENvbnRlbnRDaGlsZChEYXRhdGFibGVSb3dEZXRhaWxEaXJlY3RpdmUpXG4gIHJvd0RldGFpbCE6IERhdGF0YWJsZVJvd0RldGFpbERpcmVjdGl2ZTtcblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgY29sdW1uIHRlbXBsYXRlcy5cbiAgICovXG4gIGdldCBjb2x1bW5UZW1wbGF0ZXMoKTogUXVlcnlMaXN0PERhdGFUYWJsZUNvbHVtbkRpcmVjdGl2ZT4ge1xuICAgIHJldHVybiB0aGlzLl9jb2x1bW5UZW1wbGF0ZXM7XG4gIH1cblxuICB1cGRhdGVGaWx0ZXJJbnB1dChrZXlGaWx0ZXI/OiB7dmFsdWU6IHN0cmluZywga2V5OiBzdHJpbmcsIHR5cGU6IHN0cmluZ30pIHtcbiAgICB0aGlzLnRhYmxlZGF0YSA9IHRoaXMucm93cztcblxuICAgIGNvbnN0IHNvcnRpbmcgPSB0aGlzLmNvbmZpZy5kZWZhdWx0U29ydGluZztcbiAgICBpZiAoc29ydGluZyAmJiBzb3J0aW5nPy5sZW5ndGggPiAwICYmIHRoaXMucm93cz8ubGVuZ3RoID4gMCAmJiB0aGlzLmZpbHRlckhlYWRlci5sZW5ndGggPT09IDApIHtcbiAgICAgIHNvcnRpbmcubWFwKChzb3J0KSA9PiB7XG4gICAgICAgIGNvbnN0IF9zb3J0ID0ge2RpcmVjdGlvbjogc29ydC5kaXJlY3Rpb24sIGtleTogc29ydC5rZXksIHR5cGU6IHNvcnQudHlwZX07XG4gICAgICAgIHRoaXMuc29ydENvbHVtbkZpbHRlcklucHV0KF9zb3J0KTtcbiAgICAgIH0pXG4gICAgfVxuXG4gICAgaWYgKGtleUZpbHRlcikge1xuICAgICAgY29uc3QgZm91bmRJbmRleCA9IHRoaXMuZmlsdGVySGVhZGVyLmZpbmRJbmRleCgoZikgPT4gZi5rZXkgPT09IGtleUZpbHRlci5rZXkpO1xuICAgICAgY29uc3QgdHlwZSA9IHRoaXMuX2ludGVybmFsQ29sdW1ucy5maW5kKChmKSA9PiBmLmtleSA9PT0gIGtleUZpbHRlci5rZXkpPy5mb3JtYXQ7XG4gICAgICBpZiAoZm91bmRJbmRleCA+PSAwKSB7XG4gICAgICAgIC8vIHVwZGF0ZUZpbHRlciBmcm9tIGhlYWRlclxuICAgICAgICB0aGlzLmZpbHRlckhlYWRlcltmb3VuZEluZGV4XS52YWx1ZSA9IGtleUZpbHRlci52YWx1ZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuZmlsdGVySGVhZGVyLnB1c2goe2tleToga2V5RmlsdGVyLmtleSwgdmFsdWU6IGtleUZpbHRlci52YWx1ZSwgdHlwZToga2V5RmlsdGVyLnR5cGUgfHwgdHlwZSB9KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAodGhpcy50YWJsZWRhdGEpIHtcbiAgICAgIHRoaXMuZmlsdGVySGVhZGVyLmZvckVhY2goKGtleVZhbEZpbHRlcikgPT4ge1xuICAgICAgICB0aGlzLnRhYmxlZGF0YSA9IHRoaXMudGFibGVkYXRhLmZpbHRlcigobykgPT4ge1xuICAgICAgICAgIGxldCBfa2V5ID0ga2V5VmFsRmlsdGVyLmtleSArIChbJ0RBVEUnLCAnREFURVRJTUUnLCAnVElNRSddLmluZGV4T2Yoa2V5VmFsRmlsdGVyLnR5cGUpID49IDAgPyAnX3RvRGlzcGxheScgOiAnJyk7XG4gICAgICAgICAgY29uc3QgdmFsdWUgPSBvW19rZXldIHx8IG9ba2V5VmFsRmlsdGVyLmtleV07XG4gICAgICAgICAgcmV0dXJuICh2YWx1ZSArICcnKS50b0xvd2VyQ2FzZSgpLmluZGV4T2YoKGtleVZhbEZpbHRlci52YWx1ZSArICcnKS50b0xvd2VyQ2FzZSgpKSA+PSAwO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICB0aGlzLnRhYmxlZGF0YUZpbHRlcmVkID0gdGhpcy50YWJsZWRhdGE7XG4gIH1cblxuICBzb3J0Q29sdW1uRmlsdGVySW5wdXQoc29ydDoge2RpcmVjdGlvbjogSVN0YXRlcywga2V5OiBzdHJpbmcsIHR5cGU6IElUeXBlc30pIHtcbiAgICAvLyBwZXJmb3JtYW5jZSAtPiBkbyBub3QgY2FsbCBhZ2FpbiB1cGRhdGVGaWx0ZXJJbnB1dCByZWFzb24gb24gb3JpZ2luYWwgZGF0ZW47XG4gICAgdGhpcy50YWJsZWRhdGEgPSBbLi4udGhpcy50YWJsZWRhdGFGaWx0ZXJlZF07XG5cbiAgICBjb25zdCBmb3VuZEluZGV4ID0gdGhpcy5zb3J0SGVhZGVyLmZpbmRJbmRleCgoZikgPT4gZi5rZXkgPT09IHNvcnQua2V5KTtcbiAgICBpZiAoZm91bmRJbmRleCA+PSAwKSB7XG4gICAgICAvLyB1cGRhdGVGaWx0ZXIgZnJvbSBoZWFkZXJcbiAgICAgIHRoaXMuc29ydEhlYWRlcltmb3VuZEluZGV4XS5kaXJlY3Rpb24gPSBzb3J0LmRpcmVjdGlvbjtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5zb3J0SGVhZGVyLnB1c2goe2tleTogc29ydC5rZXksIGRpcmVjdGlvbjogc29ydC5kaXJlY3Rpb24sIHR5cGU6IHNvcnQudHlwZX0pO1xuICAgIH1cbiAgICAvLyB0aGlzLnNvcnRIZWFkZXIgPSB0aGlzLnNvcnRIZWFkZXIuZmlsdGVyKChmKSA9PiBmLmRpcmVjdGlvbiAhPT0gSVN0YXRlcy5Ob3RoaW5nKTtcblxuICAgIC8vIGxhc3QgY2hhbmdlZCAtPiBsYXN0IGZpbHRlciBoYXMgYmlnZ2VyIHByaW9yaXR5XG4gICAgLy8gbGV0IHNvcnRCeUFsbEtleXMgPSAoYToge1trZXk6IHN0cmluZ106IGFueX0sIGI6IHtba2V5OiBzdHJpbmddOiBhbnl9KTogbnVtYmVyID0+IHtcbiAgICAvLyAgIGNvbnN0IGFycjogQXJyYXk8bnVtYmVyPiA9IFtdO1xuICAgIC8vICAgdGhpcy5zb3J0SGVhZGVyLmZvckVhY2goKHIpID0+IHtcbiAgICAvLyAgICAgY29uc3QgZCA9IHIuZGlyZWN0aW9uID09PSBJU3RhdGVzLkJpZ2dlclRvU21hbGxlciA/IC0xIDogMTtcbiAgICAvLyAgICAgbGV0IHJlcyA9IChhW3Iua2V5XSArICcnKVsnbG9jYWxlQ29tcGFyZSddKGJbci5rZXldICsgJycsICdkZScsIHsgbnVtZXJpYzogci50eXBlID09PSAnbnVtYmVyJywgc2Vuc2l0aXZpdHk6IFwiY2FzZVwiIH0pO1xuICAgIC8vICAgICBhcnIucHVzaChkICogcmVzKTtcbiAgICAvLyAgIH0pO1xuICAgIC8vICAgcmV0dXJuICBhcnIuc29tZSgocykgPT4gcyA9PT0gLTEpID8gLTEgOiAxOyAgLy8gYXJyWzBdOyAvL1xuICAgIC8vIH07XG5cbiAgICAvLyBsYXN0IGNoYW5nZWQgLT4gbGFzdCBmaWx0ZXIgaGFzIHNtYWxsZXIgcHJpb3JpdHlcbiAgICBjb25zdCBzb3J0QnlBbGxLZXlzID0gKGE6IHtba2V5OiBzdHJpbmddOiBhbnl9LCBiOiB7W2tleTogc3RyaW5nXTogYW55fSk6IG51bWJlciA9PiB7XG4gICAgICBmb3IgKGxldCBpPTA7IGkgPCB0aGlzLnNvcnRIZWFkZXIubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgY29uc3Qga3kgPSB0aGlzLnNvcnRIZWFkZXJbaV0ua2V5O1xuICAgICAgICBjb25zdCB0eSA9IHRoaXMuc29ydEhlYWRlcltpXS50eXBlO1xuICAgICAgICBjb25zdCBkID0gdGhpcy5zb3J0SGVhZGVyW2ldLmRpcmVjdGlvbiA9PT0gSVN0YXRlcy5Ob3RoaW5nXG4gICAgICAgICAgICA/IDBcbiAgICAgICAgICAgIDogdGhpcy5zb3J0SGVhZGVyW2ldLmRpcmVjdGlvbiA9PT0gSVN0YXRlcy5CaWdnZXJUb1NtYWxsZXJcbiAgICAgICAgICAgICAgICA/IC0xXG4gICAgICAgICAgICAgICAgOiAxO1xuICAgICAgICBjb25zdCByZXMgPSAoYVtreV0gKyAnJylbJ2xvY2FsZUNvbXBhcmUnXShiW2t5XSArICcnLCAnZGUnLCB7IG51bWVyaWM6IHR5ID09PSAnbnVtYmVyJywgc2Vuc2l0aXZpdHk6IFwiY2FzZVwiIH0pO1xuICAgICAgICBpZiAocmVzID09PSAtMSB8fCByZXMgPT09IDEpIHtcbiAgICAgICAgICByZXR1cm4gcmVzICogZDtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgLy8gdGhlIHNhbWUgcmV0dXJuIDA7XG4gICAgICByZXR1cm4gMDtcbiAgICB9O1xuXG4gICAgY29uc29sZS5sb2coJ2JlZm9yZTonLCB0aGlzLnRhYmxlZGF0YSlcbiAgICBpZiAodGhpcy5zb3J0SGVhZGVyLmxlbmd0aCA+IDApIHtcbiAgICAgIHRoaXMudGFibGVkYXRhID0gdGhpcy50YWJsZWRhdGEuc29ydCgoYToge1trZXk6IHN0cmluZ106IGFueX0sIGI6IHtba2V5OiBzdHJpbmddOiBhbnl9KSA9PiB7XG4gICAgICAgIHJldHVybiBzb3J0QnlBbGxLZXlzKGEsIGIpO1xuICAgICAgfSk7XG4gICAgfVxuICAgIGNvbnNvbGUubG9nKCdhZnRlcicsIHRoaXMudGFibGVkYXRhKTtcbiAgfVxuXG4gIHBvc2l0aW9uUm93c0NoYW5nZWQoZGF0YTogQXJyYXk8e1trZXk6c3RyaW5nXTogYW55fT4pOiB2b2lkIHtcbiAgICB0aGlzLnRhYmxlZGF0YSA9IFsuLi5kYXRhXTtcbiAgICB0aGlzLnRhYmxlZGF0YUZpbHRlcmVkID0gWy4uLmRhdGFdO1xuICAgIHRoaXMub25DaGFuZ2VQb3NpdGlvblJvd3MuZW1pdChkYXRhKTtcbiAgfVxuXG4gIG9uSGVhZGVyU2VsZWN0KGV2ZW50OiBhbnkpIHt9XG4gIG9uQm9keVBhZ2UoZXZlbnQ6IGFueSkge31cblxuICBvblNlbGVjdFJvdyhyb3dLZXlWYWx1ZXNJbmRleDoge1trZXk6IHN0cmluZ106IGFueX0pOiB2b2lkIHtcbiAgICB0aGlzLmFjdGl2YXRlPy5lbWl0KHJvd0tleVZhbHVlc0luZGV4KTtcbiAgfVxuICBvbkJvZHlTY3JvbGwoZXZlbnQ6IGFueSkge31cbiAgb25Gb290ZXJQYWdlKGV2ZW50OiBhbnkpIHt9XG5cbn1cbiIsIjxkaXYgY2xhc3M9XCJyZXNwb25zaXZlX3RhYmxlXCI+XG5cbiAgPGFwcC10YWJsZS1oZWFkZXJcbiAgICBbY29sdW1uc109XCJfaW50ZXJuYWxDb2x1bW5zXCJcbiAgICBbaGVhZGVySGVpZ2h0XT1cIkhFSUdIVF9IRUFERVJcIlxuICAgIFthbGxSb3dzU2VsZWN0ZWRdPVwic2VsZWN0ZWRcIlxuICAgIFtzZWxlY3Rpb25UeXBlXT1cInNlbGVjdGlvblR5cGVcIlxuICAgIFtkcm9nZ2FibGVDb2x1bW5zXT1cImRyb2dnYWJsZUNvbHVtbnNcIlxuICAgIFtjb25maWddPVwiY29uZmlnXCJcbiAgICAoc2VsZWN0KT1cIm9uSGVhZGVyU2VsZWN0KCRldmVudClcIlxuICAgIChvbklucHV0VGV4dEtleSk9XCJ1cGRhdGVGaWx0ZXJJbnB1dCgkZXZlbnQpXCJcbiAgICAob25JbnB1dFNvcnRLZXkpPVwic29ydENvbHVtbkZpbHRlcklucHV0KCRldmVudClcIlxuICA+PC9hcHAtdGFibGUtaGVhZGVyPlxuICA8YXBwLXRhYmxlLWJvZHlcbiAgICBbY29uZmlnXT1cImNvbmZpZ1wiXG4gICAgW3Jvd3NdPVwidGFibGVkYXRhXCJcbiAgICBbc2Nyb2xsYmFyVl09XCJjb25maWcuc2Nyb2xsVlwiXG4gICAgW3Njcm9sbGJhckhdPVwiY29uZmlnLnNjcm9sbEhcIlxuICAgIFtsb2FkaW5nSW5kaWNhdG9yXT1cImNvbmZpZy5zaG93TG9hZGluZ1wiXG4gICAgW3Jvd0NvdW50XT1cInRhYmxlZGF0YUZpbHRlcmVkPy5sZW5ndGggKyAnJ1wiXG4gICAgW2NvbHVtbnNdPVwiX2ludGVybmFsQ29sdW1uc1wiXG4gICAgW3BhZ2VTaXplXT1cInBhZ2VTaXplXCJcbiAgICBbcm93RGV0YWlsXT1cInJvd0RldGFpbFwiXG4gICAgW3Jvd0NsYXNzXT1cInJvd0NsYXNzXCJcbiAgICBbc2VsZWN0ZWRdPVwic2VsZWN0ZWRcIlxuICAgIFtkcm9nZ2FibGVSb3dzXT1cImRyb2dnYWJsZVJvd3NcIlxuICAgIChvbkNoYW5nZVBvc2l0aW9uUm93cyk9XCJwb3NpdGlvblJvd3NDaGFuZ2VkKCRldmVudClcIlxuICAgIChwYWdlKT1cIm9uQm9keVBhZ2UoJGV2ZW50KVwiXG4gICAgKHNlbGVjdCk9XCJvblNlbGVjdFJvdygkZXZlbnQpXCJcbiAgICAoc2Nyb2xsKT1cIm9uQm9keVNjcm9sbCgkZXZlbnQpXCJcbiAgPjwvYXBwLXRhYmxlLWJvZHk+XG4gIDxhcHAtdGFibGUtZm9vdGVyXG4gICAgW3Jvd0NvdW50XT1cInRhYmxlZGF0YUZpbHRlcmVkPy5sZW5ndGggKyAnJ1wiXG4gICAgW3BhZ2VTaXplXT1cInBhZ2VTaXplXCJcbiAgICBbZm9vdGVySGVpZ2h0XT1cIkhFSUdIVF9GT09URVJcIlxuICAgIFt0b3RhbE1lc3NhZ2VdPVwiY29uZmlnLm1lc3NhZ2VUYWJsZU5vRGF0YVwiXG4gICAgKHBhZ2UpPVwib25Gb290ZXJQYWdlKCRldmVudClcIlxuICA+PC9hcHAtdGFibGUtZm9vdGVyPlxuXG48IS0tICA8ZGl2ICpuZ0lmPVwiY29uZmlnLmRpc3BsYXlUYWJsZU5hbWVcIj4gJiM0NTsmIzQ1O05BbWUmIzQ1OyYjNDU7IDwvZGl2Pi0tPlxuXG48IS0tICA8bWF0LWRpdmlkZXI+PC9tYXQtZGl2aWRlcj4tLT5cbjwhLS0gIDxkaXYgY2xhc3M9XCJyZXNwb25zaXZlX3RhYmxlX2hlYWRlclwiIHN0eWxlPVwiaGVpZ2h0OiB7e0hFSUdIVF9IRUFERVJ9fVwiPi0tPlxuPCEtLSAgICA8bWF0LWRpdmlkZXIgdmVydGljYWw9XCJ0cnVlXCI+PC9tYXQtZGl2aWRlcj4tLT5cbjwhLS0gICAgPGFwcC1yZWFjdGl2ZS10YWJsZS1pbnB1dHMtZmlsdGVyIFthdHRyXT1cInN0cnVjdFwiLS0+XG48IS0tICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAob25JbnB1dFRleHRLZXkpPVwidXBkYXRlRmlsdGVySW5wdXQoJGV2ZW50KVwiLS0+XG48IS0tICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAob25JbnB1dFNvcnRLZXkpPVwic29ydENvbHVtbkZpbHRlcklucHV0KCRldmVudClcIi0tPlxuPCEtLSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGFkZEl0ZW0pPVwiYWRkSXRlbVByb3AuZW1pdCgpXCItLT5cbjwhLS0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChyZWZyZXNoKT1cInJlZnJlc2hQcm9wLmVtaXQoKVwiLS0+XG48IS0tICAgID4tLT5cbjwhLS0gICAgPC9hcHAtcmVhY3RpdmUtdGFibGUtaW5wdXRzLWZpbHRlcj4tLT5cbjwhLS0gICAgPG1hdC1kaXZpZGVyIHZlcnRpY2FsPVwidHJ1ZVwiPjwvbWF0LWRpdmlkZXI+LS0+XG48IS0tICA8L2Rpdj4tLT5cblxuPCEtLSAgPGRpdiBjbGFzcz1cInJlc3BvbnNpdmVfdGFibGVfaGVhZGVyX2xvYWRpbmdcIiAqbmdJZj1cImNvbmZpZz8uc2hvd0xvYWRpbmcgJiYgIXJvd3NcIj4tLT5cbjwhLS0gICAgPG1hdC1kaXZpZGVyPjwvbWF0LWRpdmlkZXI+LS0+XG48IS0tICAgIDxtYXQtcHJvZ3Jlc3MtYmFyIG1vZGU9XCJpbmRldGVybWluYXRlXCI+PC9tYXQtcHJvZ3Jlc3MtYmFyPi0tPlxuPCEtLSAgPC9kaXY+LS0+XG5cbjwhLS0gIDxtYXQtZGl2aWRlcj48L21hdC1kaXZpZGVyPi0tPlxuXG48IS0tICA8ZGl2IGNsYXNzPVwicmVzcG9uc2l2ZV90YWJsZV9ib2R5XCI+LS0+XG48IS0tICAgIDxtYXQtZGl2aWRlciB2ZXJ0aWNhbD1cInRydWVcIj48L21hdC1kaXZpZGVyPi0tPlxuPCEtLSAgICA8YXBwLXJlYWN0aXZlLXRhYmxlLXJvdy1jZWxsIFtkYXRhXT1cInRhYmxlZGF0YVwiLS0+XG48IS0tICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgW2F0dHJdPVwic3RydWN0XCItLT5cbjwhLS0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAob25DbGlja1Jvdyk9XCJjb25maWcub25TZWxlY3RSb3coJGV2ZW50KVwiLS0+XG48IS0tICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgW2NvbmZpZ109XCJjb25maWdcIi0tPlxuPCEtLSAgICA+LS0+XG48IS0tICAgIDwvYXBwLXJlYWN0aXZlLXRhYmxlLXJvdy1jZWxsPi0tPlxuPCEtLSAgICA8bWF0LWRpdmlkZXIgdmVydGljYWw9XCJ0cnVlXCI+PC9tYXQtZGl2aWRlcj4tLT5cbjwhLS0gIDwvZGl2Pi0tPlxuXG48IS0tICA8bWF0LWRpdmlkZXI+PC9tYXQtZGl2aWRlcj4tLT5cbjwhLS0gIDxkaXYgKm5nSWY9XCIhY29uZmlnPy5kaXNwbGF5Rm9vdGVyID09PSBmYWxzZVwiIGNsYXNzPVwicmVzcG9uc2l2ZV90YWJsZV9mb290ZXJcIiBzdHlsZT1cImhlaWdodDoge3tIRUlHSFRfRk9PVEVSfX1cIj4tLT5cbjwhLS0gICAgPG1hdC1kaXZpZGVyIHZlcnRpY2FsPVwidHJ1ZVwiPjwvbWF0LWRpdmlkZXI+LS0+XG48IS0tICAgIDxhcHAtYXBwLXJlYWN0aXZlLXRhYmxlLWZvb3Rlcj48L2FwcC1hcHAtcmVhY3RpdmUtdGFibGUtZm9vdGVyPi0tPlxuPCEtLSAgICA8bWF0LWRpdmlkZXIgdmVydGljYWw9XCJ0cnVlXCIgc3R5bGU9XCJoZWlnaHQ6IDEwMCVcIj48L21hdC1kaXZpZGVyPi0tPlxuPCEtLSAgPC9kaXY+LS0+XG48IS0tICA8bWF0LWRpdmlkZXI+PC9tYXQtZGl2aWRlcj4tLT5cbjwvZGl2PlxuIl19