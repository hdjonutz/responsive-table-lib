import { Component, ContentChild, ContentChildren, EventEmitter, Input, Output } from '@angular/core';
import { IStates, SelectionType } from "./table-responsive-interface";
import { DataTableColumnDirective } from "../directive/column/column.directive";
import { DatatableRowDetailDirective } from "../directive/row-detail/row-detail.directive";
import * as i0 from "@angular/core";
import * as i1 from "./table-header/table-header.component";
import * as i2 from "./table-body/table-body.component";
import * as i3 from "./table-footer/table-footer.component";
export class TableResponsiveComponent {
    constructor() {
        this.selectionType = SelectionType.simple;
        this._internalColumns = [];
        this.HEIGHT_ROW = 50;
        this.filterHeader = [];
        this.sortHeader = [];
        this.pageSize = Infinity;
        this.selected = [];
        this.activate = new EventEmitter();
        this.refreshProp = new EventEmitter();
        this.addItemProp = new EventEmitter();
        this.onChangePositionRows = new EventEmitter();
    }
    ngOnChanges(changes) {
        if (changes['rows']?.currentValue) {
            this.tabledata = [...changes['rows'].currentValue];
            this.tabledataFiltered = [...changes['rows'].currentValue];
            // console.log('Table receive data.length:'  +this.tabledataFiltered.length);
        }
        if (changes['selected']?.currentValue) {
            this.selected = changes['selected']?.currentValue;
        }
        if (changes['externalFilters']) {
            // console.log('Framework', changes['externalFilters']);
        }
        // console.log('Framework', changes['externalFilters']);
        this.updateFilterInput();
    }
    ngOnInit() {
        this.HEIGHT_HEADER = this.config?.headerHeight ? this.config.headerHeight : this.HEIGHT_HEADER;
        this.HEIGHT_FOOTER = this.config?.footerHeight ? this.config.footerHeight : this.HEIGHT_FOOTER;
        this.HEIGHT_FOOTER = this.config?.rowHeight ? this.config.rowHeight : this.HEIGHT_ROW;
    }
    /**
     * Column templates gathered from `ContentChildren`
     * if described in your markup.
     */
    set columnTemplates(val) {
        this._columnTemplates = val;
        this._internalColumns = val.toArray();
    }
    /**
     * Returns the column templates.
     */
    get columnTemplates() {
        return this._columnTemplates;
    }
    updateFilterInput(keyFilter) {
        this.tabledata = this.rows;
        if (keyFilter) {
            const foundIndex = this.filterHeader.findIndex((f) => f.key === keyFilter.key);
            if (foundIndex >= 0) {
                // updateFilter from header
                this.filterHeader[foundIndex].value = keyFilter.value;
            }
            else {
                this.filterHeader.push({ key: keyFilter.key, value: keyFilter.value, type: keyFilter.type });
            }
        }
        this.tabledata = this.rows;
        if (this.tabledata) {
            this.filterHeader.forEach((keyValFilter) => {
                this.tabledata = this.tabledata.filter((o) => {
                    let _key = o[keyValFilter.key] + ['DATE', 'DATETIME', 'TIME'].indexOf(keyValFilter.key) >= 0 ? '_toDisplay' : '';
                    _key = o[_key] || o[keyValFilter.key];
                    return (_key + '').toLowerCase().indexOf((keyValFilter.value + '').toLowerCase()) >= 0;
                });
            });
        }
        this.tabledataFiltered = this.tabledata;
    }
    sortColumnFilterInput(sort) {
        // performance -> do not call again updateFilterInput reason on original daten;
        this.tabledata = [...this.tabledataFiltered];
        const foundIndex = this.sortHeader.findIndex((f) => f.key === sort.key);
        if (foundIndex >= 0) {
            // updateFilter from header
            this.sortHeader[foundIndex].direction = sort.direction;
        }
        else {
            this.sortHeader.push({ key: sort.key, direction: sort.direction, type: sort.type });
        }
        this.sortHeader = this.sortHeader.filter((f) => f.direction !== IStates.Nothing);
        // last changed -> last filter has bigger priority
        // let sortByAllKeys = (a: {[key: string]: any}, b: {[key: string]: any}): number => {
        //   const arr: Array<number> = [];
        //   this.sortHeader.forEach((r) => {
        //     const d = r.direction === IStates.BiggerToSmaller ? -1 : 1;
        //     let res = (a[r.key] + '')['localeCompare'](b[r.key] + '', 'de', { numeric: r.type === 'number', sensitivity: "case" });
        //     arr.push(d * res);
        //   });
        //   return  arr.some((s) => s === -1) ? -1 : 1;  // arr[0]; //
        // };
        // last changed -> last filter has smaller priority
        const sortByAllKeys = (a, b) => {
            for (let i = 0; i < this.sortHeader.length; i++) {
                const ky = this.sortHeader[i].key;
                const ty = this.sortHeader[i].type;
                const d = this.sortHeader[i].direction === IStates.BiggerToSmaller ? -1 : 1;
                const res = (a[ky] + '')['localeCompare'](b[ky] + '', 'de', { numeric: ty === 'number', sensitivity: "case" });
                if (res === -1 || res === 1) {
                    return res * d;
                }
            }
            // the same return 0;
            return 0;
        };
        if (this.sortHeader.length > 0) {
            this.tabledata.sort((a, b) => {
                return sortByAllKeys(a, b);
            });
        }
    }
    positionRowsChanged(data) {
        this.tabledata = [...data];
        this.tabledataFiltered = [...data];
        this.onChangePositionRows.emit(data);
    }
    onHeaderSelect(event) { }
    onBodyPage(event) { }
    onSelectRow(rowKeyValuesIndex) {
        this.activate?.emit(rowKeyValuesIndex);
    }
    onBodyScroll(event) { }
    onFooterPage(event) { }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: TableResponsiveComponent, deps: [], target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "16.2.12", type: TableResponsiveComponent, selector: "lib-table-responsive", inputs: { rows: "rows", config: "config", selected: "selected", droggableColumns: "droggableColumns", droggableRows: "droggableRows", externalFilters: "externalFilters" }, outputs: { activate: "activate", refreshProp: "refreshProp", addItemProp: "addItemProp", onChangePositionRows: "onChangePositionRows" }, queries: [{ propertyName: "rowDetail", first: true, predicate: DatatableRowDetailDirective, descendants: true }, { propertyName: "columnTemplates", predicate: DataTableColumnDirective }], usesOnChanges: true, ngImport: i0, template: "<div class=\"responsive_table\">\n\n  <app-table-header\n    [columns]=\"_internalColumns\"\n    [headerHeight]=\"HEIGHT_HEADER\"\n    [allRowsSelected]=\"selected\"\n    [selectionType]=\"selectionType\"\n    [droggableColumns]=\"droggableColumns\"\n    (select)=\"onHeaderSelect($event)\"\n    (onInputTextKey)=\"updateFilterInput($event)\"\n    (onInputSortKey)=\"sortColumnFilterInput($event)\"\n  ></app-table-header>\n  <app-table-body\n    [config]=\"config\"\n    [rows]=\"tabledata\"\n    [scrollbarV]=\"config.scrollV\"\n    [scrollbarH]=\"config.scrollH\"\n    [loadingIndicator]=\"config.showLoading\"\n    [rowCount]=\"tabledataFiltered?.length + ''\"\n    [columns]=\"_internalColumns\"\n    [pageSize]=\"pageSize\"\n    [rowDetail]=\"rowDetail\"\n    [rowClass]=\"rowClass\"\n    [selected]=\"selected\"\n    [droggableRows]=\"droggableRows\"\n    (onChangePositionRows)=\"positionRowsChanged($event)\"\n    (page)=\"onBodyPage($event)\"\n    (select)=\"onSelectRow($event)\"\n    (scroll)=\"onBodyScroll($event)\"\n  ></app-table-body>\n  <app-table-footer\n    [rowCount]=\"tabledataFiltered?.length + ''\"\n    [pageSize]=\"pageSize\"\n    [footerHeight]=\"HEIGHT_FOOTER\"\n    [totalMessage]=\"config.messageTableNoData\"\n    (page)=\"onFooterPage($event)\"\n  ></app-table-footer>\n\n<!--  <div *ngIf=\"config.displayTableName\"> &#45;&#45;NAme&#45;&#45; </div>-->\n\n<!--  <mat-divider></mat-divider>-->\n<!--  <div class=\"responsive_table_header\" style=\"height: {{HEIGHT_HEADER}}\">-->\n<!--    <mat-divider vertical=\"true\"></mat-divider>-->\n<!--    <app-reactive-table-inputs-filter [attr]=\"struct\"-->\n<!--                                      (onInputTextKey)=\"updateFilterInput($event)\"-->\n<!--                                      (onInputSortKey)=\"sortColumnFilterInput($event)\"-->\n<!--                                      (addItem)=\"addItemProp.emit()\"-->\n<!--                                      (refresh)=\"refreshProp.emit()\"-->\n<!--    >-->\n<!--    </app-reactive-table-inputs-filter>-->\n<!--    <mat-divider vertical=\"true\"></mat-divider>-->\n<!--  </div>-->\n\n<!--  <div class=\"responsive_table_header_loading\" *ngIf=\"config?.showLoading && !rows\">-->\n<!--    <mat-divider></mat-divider>-->\n<!--    <mat-progress-bar mode=\"indeterminate\"></mat-progress-bar>-->\n<!--  </div>-->\n\n<!--  <mat-divider></mat-divider>-->\n\n<!--  <div class=\"responsive_table_body\">-->\n<!--    <mat-divider vertical=\"true\"></mat-divider>-->\n<!--    <app-reactive-table-row-cell [data]=\"tabledata\"-->\n<!--                                 [attr]=\"struct\"-->\n<!--                                 (onClickRow)=\"config.onSelectRow($event)\"-->\n<!--                                 [config]=\"config\"-->\n<!--    >-->\n<!--    </app-reactive-table-row-cell>-->\n<!--    <mat-divider vertical=\"true\"></mat-divider>-->\n<!--  </div>-->\n\n<!--  <mat-divider></mat-divider>-->\n<!--  <div *ngIf=\"!config?.displayFooter === false\" class=\"responsive_table_footer\" style=\"height: {{HEIGHT_FOOTER}}\">-->\n<!--    <mat-divider vertical=\"true\"></mat-divider>-->\n<!--    <app-app-reactive-table-footer></app-app-reactive-table-footer>-->\n<!--    <mat-divider vertical=\"true\" style=\"height: 100%\"></mat-divider>-->\n<!--  </div>-->\n<!--  <mat-divider></mat-divider>-->\n</div>\n", styles: [".flex_column,.flex_column_min_width_height,.responsive_table,:host{display:flex;flex:1;flex-direction:column}.flex_row{display:flex;flex:1;flex-direction:row}.max_height_width{height:100%;width:100%;min-width:0;min-height:0}.flex_column_min_width_height,.responsive_table,:host{min-width:0;min-height:0}*{scrollbar-width:thin;scrollbar-color:#5287bd #DFE9EB}*::-webkit-scrollbar{height:10px;width:10px}*::-webkit-scrollbar-track{border-radius:3px;background-color:#d3d8da}*::-webkit-scrollbar-track:hover{background-color:#b8c0c2}*::-webkit-scrollbar-track:active{background-color:#b8c0c2}*::-webkit-scrollbar-thumb{border-radius:3px;background-color:#5287bd}*::-webkit-scrollbar-thumb:hover{background-color:#77a1cb}*::-webkit-scrollbar-thumb:active{background-color:#3d6e9f}.responsive_table{border:1px solid #5287bd}.responsive_table .responsive_table_header{display:flex;background-color:#5287bd;color:#fff}.responsive_table .responsive_table_body{min-width:0;min-height:0;display:flex;flex:1}.responsive_table .responsive_table_footer{display:flex}\n"], dependencies: [{ kind: "component", type: i1.TableHeaderComponent, selector: "app-table-header", inputs: ["columns", "headerHeight", "allRowsSelected", "selectionType", "droggableColumns"], outputs: ["select", "onInputTextKey", "onInputSortKey", "addItem", "refresh"] }, { kind: "component", type: i2.TableBodyComponent, selector: "app-table-body", inputs: ["config", "columns", "rows", "scrollbarV", "scrollbarH", "loadingIndicator", "rowCount", "pageSize", "rowDetail", "rowClass", "selected", "droggableRows"], outputs: ["page", "select", "onChangePositionRows", "scroll"] }, { kind: "component", type: i3.TableFooterComponent, selector: "app-table-footer", inputs: ["rowCount", "pageSize", "footerHeight", "totalMessage"], outputs: ["page"] }] }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: TableResponsiveComponent, decorators: [{
            type: Component,
            args: [{ selector: 'lib-table-responsive', template: "<div class=\"responsive_table\">\n\n  <app-table-header\n    [columns]=\"_internalColumns\"\n    [headerHeight]=\"HEIGHT_HEADER\"\n    [allRowsSelected]=\"selected\"\n    [selectionType]=\"selectionType\"\n    [droggableColumns]=\"droggableColumns\"\n    (select)=\"onHeaderSelect($event)\"\n    (onInputTextKey)=\"updateFilterInput($event)\"\n    (onInputSortKey)=\"sortColumnFilterInput($event)\"\n  ></app-table-header>\n  <app-table-body\n    [config]=\"config\"\n    [rows]=\"tabledata\"\n    [scrollbarV]=\"config.scrollV\"\n    [scrollbarH]=\"config.scrollH\"\n    [loadingIndicator]=\"config.showLoading\"\n    [rowCount]=\"tabledataFiltered?.length + ''\"\n    [columns]=\"_internalColumns\"\n    [pageSize]=\"pageSize\"\n    [rowDetail]=\"rowDetail\"\n    [rowClass]=\"rowClass\"\n    [selected]=\"selected\"\n    [droggableRows]=\"droggableRows\"\n    (onChangePositionRows)=\"positionRowsChanged($event)\"\n    (page)=\"onBodyPage($event)\"\n    (select)=\"onSelectRow($event)\"\n    (scroll)=\"onBodyScroll($event)\"\n  ></app-table-body>\n  <app-table-footer\n    [rowCount]=\"tabledataFiltered?.length + ''\"\n    [pageSize]=\"pageSize\"\n    [footerHeight]=\"HEIGHT_FOOTER\"\n    [totalMessage]=\"config.messageTableNoData\"\n    (page)=\"onFooterPage($event)\"\n  ></app-table-footer>\n\n<!--  <div *ngIf=\"config.displayTableName\"> &#45;&#45;NAme&#45;&#45; </div>-->\n\n<!--  <mat-divider></mat-divider>-->\n<!--  <div class=\"responsive_table_header\" style=\"height: {{HEIGHT_HEADER}}\">-->\n<!--    <mat-divider vertical=\"true\"></mat-divider>-->\n<!--    <app-reactive-table-inputs-filter [attr]=\"struct\"-->\n<!--                                      (onInputTextKey)=\"updateFilterInput($event)\"-->\n<!--                                      (onInputSortKey)=\"sortColumnFilterInput($event)\"-->\n<!--                                      (addItem)=\"addItemProp.emit()\"-->\n<!--                                      (refresh)=\"refreshProp.emit()\"-->\n<!--    >-->\n<!--    </app-reactive-table-inputs-filter>-->\n<!--    <mat-divider vertical=\"true\"></mat-divider>-->\n<!--  </div>-->\n\n<!--  <div class=\"responsive_table_header_loading\" *ngIf=\"config?.showLoading && !rows\">-->\n<!--    <mat-divider></mat-divider>-->\n<!--    <mat-progress-bar mode=\"indeterminate\"></mat-progress-bar>-->\n<!--  </div>-->\n\n<!--  <mat-divider></mat-divider>-->\n\n<!--  <div class=\"responsive_table_body\">-->\n<!--    <mat-divider vertical=\"true\"></mat-divider>-->\n<!--    <app-reactive-table-row-cell [data]=\"tabledata\"-->\n<!--                                 [attr]=\"struct\"-->\n<!--                                 (onClickRow)=\"config.onSelectRow($event)\"-->\n<!--                                 [config]=\"config\"-->\n<!--    >-->\n<!--    </app-reactive-table-row-cell>-->\n<!--    <mat-divider vertical=\"true\"></mat-divider>-->\n<!--  </div>-->\n\n<!--  <mat-divider></mat-divider>-->\n<!--  <div *ngIf=\"!config?.displayFooter === false\" class=\"responsive_table_footer\" style=\"height: {{HEIGHT_FOOTER}}\">-->\n<!--    <mat-divider vertical=\"true\"></mat-divider>-->\n<!--    <app-app-reactive-table-footer></app-app-reactive-table-footer>-->\n<!--    <mat-divider vertical=\"true\" style=\"height: 100%\"></mat-divider>-->\n<!--  </div>-->\n<!--  <mat-divider></mat-divider>-->\n</div>\n", styles: [".flex_column,.flex_column_min_width_height,.responsive_table,:host{display:flex;flex:1;flex-direction:column}.flex_row{display:flex;flex:1;flex-direction:row}.max_height_width{height:100%;width:100%;min-width:0;min-height:0}.flex_column_min_width_height,.responsive_table,:host{min-width:0;min-height:0}*{scrollbar-width:thin;scrollbar-color:#5287bd #DFE9EB}*::-webkit-scrollbar{height:10px;width:10px}*::-webkit-scrollbar-track{border-radius:3px;background-color:#d3d8da}*::-webkit-scrollbar-track:hover{background-color:#b8c0c2}*::-webkit-scrollbar-track:active{background-color:#b8c0c2}*::-webkit-scrollbar-thumb{border-radius:3px;background-color:#5287bd}*::-webkit-scrollbar-thumb:hover{background-color:#77a1cb}*::-webkit-scrollbar-thumb:active{background-color:#3d6e9f}.responsive_table{border:1px solid #5287bd}.responsive_table .responsive_table_header{display:flex;background-color:#5287bd;color:#fff}.responsive_table .responsive_table_body{min-width:0;min-height:0;display:flex;flex:1}.responsive_table .responsive_table_footer{display:flex}\n"] }]
        }], ctorParameters: function () { return []; }, propDecorators: { rows: [{
                type: Input
            }], config: [{
                type: Input
            }], selected: [{
                type: Input
            }], droggableColumns: [{
                type: Input
            }], droggableRows: [{
                type: Input
            }], externalFilters: [{
                type: Input
            }], activate: [{
                type: Output
            }], refreshProp: [{
                type: Output
            }], addItemProp: [{
                type: Output
            }], onChangePositionRows: [{
                type: Output
            }], columnTemplates: [{
                type: ContentChildren,
                args: [DataTableColumnDirective]
            }], rowDetail: [{
                type: ContentChild,
                args: [DatatableRowDetailDirective]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFibGUtcmVzcG9uc2l2ZS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy90YWJsZS1yZXNwb25zaXZlL3NyYy9saWIvY29tcG9uZW50cy90YWJsZS1yZXNwb25zaXZlLmNvbXBvbmVudC50cyIsIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3RhYmxlLXJlc3BvbnNpdmUvc3JjL2xpYi9jb21wb25lbnRzL3RhYmxlLXJlc3BvbnNpdmUuY29tcG9uZW50Lmh0bWwiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLFNBQVMsRUFBRSxZQUFZLEVBQ3ZCLGVBQWUsRUFDZixZQUFZLEVBQ1osS0FBSyxFQUdMLE1BQU0sRUFHUCxNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQXlCLE9BQU8sRUFBVSxhQUFhLEVBQUMsTUFBTSw4QkFBOEIsQ0FBQztBQUNwRyxPQUFPLEVBQUMsd0JBQXdCLEVBQUMsTUFBTSxzQ0FBc0MsQ0FBQztBQUM5RSxPQUFPLEVBQUMsMkJBQTJCLEVBQUMsTUFBTSw4Q0FBOEMsQ0FBQzs7Ozs7QUFPekYsTUFBTSxPQUFPLHdCQUF3QjtJQWdDbkM7UUEvQlUsa0JBQWEsR0FBa0IsYUFBYSxDQUFDLE1BQU0sQ0FBQztRQUU5RCxxQkFBZ0IsR0FBZSxFQUFFLENBQUM7UUFJbEMsZUFBVSxHQUFRLEVBQUUsQ0FBQztRQUlyQixpQkFBWSxHQUE0RCxFQUFFLENBQUM7UUFDM0UsZUFBVSxHQUE4RCxFQUFFLENBQUM7UUFDM0UsYUFBUSxHQUFnRSxRQUFRLENBQUM7UUFNeEUsYUFBUSxHQUFnQixFQUFFLENBQUM7UUFNMUIsYUFBUSxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFFOUIsZ0JBQVcsR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO1FBQ2pDLGdCQUFXLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUNqQyx5QkFBb0IsR0FBNkMsSUFBSSxZQUFZLEVB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OytCQUNFLHNCQUFzQjswRUFxQnZCLElBQUk7c0JBQVosS0FBSztnQkFDRyxNQUFNO3NCQUFkLEtBQUs7Z0JBQ0csUUFBUTtzQkFBaEIsS0FBSztnQkFFRyxnQkFBZ0I7c0JBQXhCLEtBQUs7Z0JBQ0csYUFBYTtzQkFBckIsS0FBSztnQkFDRyxlQUFlO3NCQUF2QixLQUFLO2dCQUVJLFFBQVE7c0JBQWpCLE1BQU07Z0JBRUcsV0FBVztzQkFBcEIsTUFBTTtnQkFDRyxXQUFXO3NCQUFwQixNQUFNO2dCQUNHLG9CQUFvQjtzQkFBN0IsTUFBTTtnQkFpQ0gsZUFBZTtzQkFEbEIsZUFBZTt1QkFBQyx3QkFBd0I7Z0JBT3pDLFNBQVM7c0JBRFIsWUFBWTt1QkFBQywyQkFBMkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDb21wb25lbnQsIENvbnRlbnRDaGlsZCxcbiAgQ29udGVudENoaWxkcmVuLFxuICBFdmVudEVtaXR0ZXIsXG4gIElucHV0LFxuICBPbkNoYW5nZXMsXG4gIE9uSW5pdCxcbiAgT3V0cHV0LFxuICBRdWVyeUxpc3QsXG4gIFNpbXBsZUNoYW5nZXNcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge0lSZXNwb25zaXZlVGFibGVDb25maWcsIElTdGF0ZXMsIElUeXBlcywgU2VsZWN0aW9uVHlwZX0gZnJvbSBcIi4vdGFibGUtcmVzcG9uc2l2ZS1pbnRlcmZhY2VcIjtcbmltcG9ydCB7RGF0YVRhYmxlQ29sdW1uRGlyZWN0aXZlfSBmcm9tIFwiLi4vZGlyZWN0aXZlL2NvbHVtbi9jb2x1bW4uZGlyZWN0aXZlXCI7XG5pbXBvcnQge0RhdGF0YWJsZVJvd0RldGFpbERpcmVjdGl2ZX0gZnJvbSBcIi4uL2RpcmVjdGl2ZS9yb3ctZGV0YWlsL3Jvdy1kZXRhaWwuZGlyZWN0aXZlXCI7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2xpYi10YWJsZS1yZXNwb25zaXZlJyxcbiAgdGVtcGxhdGVVcmw6ICcuL3RhYmxlLXJlc3BvbnNpdmUuY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi90YWJsZS1yZXNwb25zaXZlLmNvbXBvbmVudC5zY3NzJ11cbn0pXG5leHBvcnQgY2xhc3MgVGFibGVSZXNwb25zaXZlQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkNoYW5nZXMge1xuICBwcm90ZWN0ZWQgc2VsZWN0aW9uVHlwZTogU2VsZWN0aW9uVHlwZSA9IFNlbGVjdGlvblR5cGUuc2ltcGxlO1xuXG4gIF9pbnRlcm5hbENvbHVtbnM6IEFycmF5PGFueT4gPSBbXTtcblxuICBIRUlHSFRfSEVBREVSITogbnVtYmVyO1xuICBIRUlHSFRfRk9PVEVSITogbnVtYmVyO1xuICBIRUlHSFRfUk9XICAgICAgPSA1MDtcblxuICB0YWJsZWRhdGEhOiBBcnJheTx7IFtrZXk6IHN0cmluZ106IGFueSB9PjtcbiAgdGFibGVkYXRhRmlsdGVyZWQhOiBBcnJheTx7IFtrZXk6IHN0cmluZ106IGFueSB9PjtcbiAgZmlsdGVySGVhZGVyOiBBcnJheTx7IGtleTogc3RyaW5nOyB2YWx1ZTogc3RyaW5nLCB0eXBlOiBzdHJpbmcgfT4gICAgID0gW107XG4gIHNvcnRIZWFkZXI6IEFycmF5PHsga2V5OiBzdHJpbmc7IGRpcmVjdGlvbjogSVN0YXRlcywgdHlwZTogSVR5cGVzfT4gICA9IFtdO1xuICBwYWdlU2l6ZTogbnVtYmVyICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPSBJbmZpbml0eTtcbiAgLy8gcm93RGV0YWlsIToge2tleUluZGV4OiBzdHJpbmcsIHNob3c6IGJvb2xlYW4sIHJvdzogYW55fTtcbiAgcm93Q2xhc3MhOiB7a2V5SW5kZXg6IHN0cmluZywgY2xhc3NOYW1lOiBib29sZWFuLCByb3c6IGFueX07XG5cbiAgQElucHV0KCkgcm93cyE6ICAgICBBcnJheTx7W2tleTogc3RyaW5nXTogYW55fT47XG4gIEBJbnB1dCgpIGNvbmZpZyE6ICAgSVJlc3BvbnNpdmVUYWJsZUNvbmZpZztcbiAgQElucHV0KCkgc2VsZWN0ZWQ6ICBBcnJheTxhbnk+ID0gW107XG5cbiAgQElucHV0KCkgZHJvZ2dhYmxlQ29sdW1ucyE6IGJvb2xlYW47XG4gIEBJbnB1dCgpIGRyb2dnYWJsZVJvd3MhOiBib29sZWFuO1xuICBASW5wdXQoKSBleHRlcm5hbEZpbHRlcnMhOiB7W2tleTogc3RyaW5nXTogYW55fTtcblxuICBAT3V0cHV0KCkgYWN0aXZhdGUgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG5cbiAgQE91dHB1dCgpIHJlZnJlc2hQcm9wID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICBAT3V0cHV0KCkgYWRkSXRlbVByb3AgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIEBPdXRwdXQoKSBvbkNoYW5nZVBvc2l0aW9uUm93czogRXZlbnRFbWl0dGVyPEFycmF5PHtba2V5OnN0cmluZ106IGFueX0+PiA9IG5ldyBFdmVudEVtaXR0ZXI8QXJyYXk8e1twOiBzdHJpbmddOiBhbnl9Pj4oKTtcblxuICBfY29sdW1uVGVtcGxhdGVzITogUXVlcnlMaXN0PERhdGFUYWJsZUNvbHVtbkRpcmVjdGl2ZT47XG4gIGNvbnN0cnVjdG9yKCkge31cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XG4gICAgaWYgKGNoYW5nZXNbJ3Jvd3MnXT8uY3VycmVudFZhbHVlKSB7XG4gICAgICB0aGlzLnRhYmxlZGF0YSA9ICAgICAgICAgIFsuLi5jaGFuZ2VzWydyb3dzJ10uY3VycmVudFZhbHVlXTtcbiAgICAgIHRoaXMudGFibGVkYXRhRmlsdGVyZWQgPSAgWy4uLmNoYW5nZXNbJ3Jvd3MnXS5jdXJyZW50VmFsdWVdO1xuICAgICAgLy8gY29uc29sZS5sb2coJ1RhYmxlIHJlY2VpdmUgZGF0YS5sZW5ndGg6JyAgK3RoaXMudGFibGVkYXRhRmlsdGVyZWQubGVuZ3RoKTtcbiAgICB9XG4gICAgaWYgKGNoYW5nZXNbJ3NlbGVjdGVkJ10/LmN1cnJlbnRWYWx1ZSkge1xuICAgICAgdGhpcy5zZWxlY3RlZCA9IGNoYW5nZXNbJ3NlbGVjdGVkJ10/LmN1cnJlbnRWYWx1ZTtcbiAgICB9XG4gICAgaWYgKGNoYW5nZXNbJ2V4dGVybmFsRmlsdGVycyddKSB7XG4gICAgICAvLyBjb25zb2xlLmxvZygnRnJhbWV3b3JrJywgY2hhbmdlc1snZXh0ZXJuYWxGaWx0ZXJzJ10pO1xuICAgIH1cbiAgICAvLyBjb25zb2xlLmxvZygnRnJhbWV3b3JrJywgY2hhbmdlc1snZXh0ZXJuYWxGaWx0ZXJzJ10pO1xuXG4gICAgdGhpcy51cGRhdGVGaWx0ZXJJbnB1dCgpO1xuICB9XG5cbiAgbmdPbkluaXQoKTogdm9pZCB7XG4gICAgdGhpcy5IRUlHSFRfSEVBREVSID0gdGhpcy5jb25maWc/LmhlYWRlckhlaWdodCA/IHRoaXMuY29uZmlnLmhlYWRlckhlaWdodCA6IHRoaXMuSEVJR0hUX0hFQURFUjtcbiAgICB0aGlzLkhFSUdIVF9GT09URVIgPSB0aGlzLmNvbmZpZz8uZm9vdGVySGVpZ2h0ID8gdGhpcy5jb25maWcuZm9vdGVySGVpZ2h0IDogdGhpcy5IRUlHSFRfRk9PVEVSO1xuICAgIHRoaXMuSEVJR0hUX0ZPT1RFUiA9IHRoaXMuY29uZmlnPy5yb3dIZWlnaHQgPyB0aGlzLmNvbmZpZy5yb3dIZWlnaHQgOiB0aGlzLkhFSUdIVF9ST1c7XG4gIH1cblxuICAvKipcbiAgICogQ29sdW1uIHRlbXBsYXRlcyBnYXRoZXJlZCBmcm9tIGBDb250ZW50Q2hpbGRyZW5gXG4gICAqIGlmIGRlc2NyaWJlZCBpbiB5b3VyIG1hcmt1cC5cbiAgICovXG4gIEBDb250ZW50Q2hpbGRyZW4oRGF0YVRhYmxlQ29sdW1uRGlyZWN0aXZlKVxuICBzZXQgY29sdW1uVGVtcGxhdGVzKHZhbDogUXVlcnlMaXN0PERhdGFUYWJsZUNvbHVtbkRpcmVjdGl2ZT4pIHtcbiAgICB0aGlzLl9jb2x1bW5UZW1wbGF0ZXMgPSB2YWw7XG4gICAgdGhpcy5faW50ZXJuYWxDb2x1bW5zID0gdmFsLnRvQXJyYXkoKTtcbiAgfVxuXG4gIEBDb250ZW50Q2hpbGQoRGF0YXRhYmxlUm93RGV0YWlsRGlyZWN0aXZlKVxuICByb3dEZXRhaWwhOiBEYXRhdGFibGVSb3dEZXRhaWxEaXJlY3RpdmU7XG5cbiAgLyoqXG4gICAqIFJldHVybnMgdGhlIGNvbHVtbiB0ZW1wbGF0ZXMuXG4gICAqL1xuICBnZXQgY29sdW1uVGVtcGxhdGVzKCk6IFF1ZXJ5TGlzdDxEYXRhVGFibGVDb2x1bW5EaXJlY3RpdmU+IHtcbiAgICByZXR1cm4gdGhpcy5fY29sdW1uVGVtcGxhdGVzO1xuICB9XG5cbiAgdXBkYXRlRmlsdGVySW5wdXQoa2V5RmlsdGVyPzoge3ZhbHVlOiBzdHJpbmcsIGtleTogc3RyaW5nLCB0eXBlOiBzdHJpbmd9KSB7XG4gICAgdGhpcy50YWJsZWRhdGEgPSB0aGlzLnJvd3M7XG4gICAgaWYgKGtleUZpbHRlcikge1xuICAgICAgY29uc3QgZm91bmRJbmRleCA9IHRoaXMuZmlsdGVySGVhZGVyLmZpbmRJbmRleCgoZikgPT4gZi5rZXkgPT09IGtleUZpbHRlci5rZXkpO1xuICAgICAgaWYgKGZvdW5kSW5kZXggPj0gMCkge1xuICAgICAgICAvLyB1cGRhdGVGaWx0ZXIgZnJvbSBoZWFkZXJcbiAgICAgICAgdGhpcy5maWx0ZXJIZWFkZXJbZm91bmRJbmRleF0udmFsdWUgPSBrZXlGaWx0ZXIudmFsdWU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmZpbHRlckhlYWRlci5wdXNoKHtrZXk6IGtleUZpbHRlci5rZXksIHZhbHVlOiBrZXlGaWx0ZXIudmFsdWUsIHR5cGU6IGtleUZpbHRlci50eXBlfSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgdGhpcy50YWJsZWRhdGEgPSB0aGlzLnJvd3M7XG4gICAgaWYgKHRoaXMudGFibGVkYXRhKSB7XG4gICAgICB0aGlzLmZpbHRlckhlYWRlci5mb3JFYWNoKChrZXlWYWxGaWx0ZXIpID0+IHtcbiAgICAgICAgdGhpcy50YWJsZWRhdGEgPSB0aGlzLnRhYmxlZGF0YS5maWx0ZXIoKG8pID0+IHtcbiAgICAgICAgICBsZXQgX2tleSA9IG9ba2V5VmFsRmlsdGVyLmtleV0gKyBbJ0RBVEUnLCAnREFURVRJTUUnLCAnVElNRSddLmluZGV4T2Yoa2V5VmFsRmlsdGVyLmtleSkgPj0gMCA/ICdfdG9EaXNwbGF5JyA6ICcnO1xuICAgICAgICAgIF9rZXkgPSBvW19rZXldIHx8IG9ba2V5VmFsRmlsdGVyLmtleV07XG4gICAgICAgICAgcmV0dXJuIChfa2V5ICsgJycpLnRvTG93ZXJDYXNlKCkuaW5kZXhPZigoa2V5VmFsRmlsdGVyLnZhbHVlICsgJycpLnRvTG93ZXJDYXNlKCkpID49IDA7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfVxuICAgIHRoaXMudGFibGVkYXRhRmlsdGVyZWQgPSB0aGlzLnRhYmxlZGF0YTtcbiAgfVxuXG4gIHNvcnRDb2x1bW5GaWx0ZXJJbnB1dChzb3J0OiB7ZGlyZWN0aW9uOiBJU3RhdGVzLCBrZXk6IHN0cmluZywgdHlwZTogSVR5cGVzfSkge1xuICAgIC8vIHBlcmZvcm1hbmNlIC0+IGRvIG5vdCBjYWxsIGFnYWluIHVwZGF0ZUZpbHRlcklucHV0IHJlYXNvbiBvbiBvcmlnaW5hbCBkYXRlbjtcbiAgICB0aGlzLnRhYmxlZGF0YSA9IFsuLi50aGlzLnRhYmxlZGF0YUZpbHRlcmVkXTtcblxuICAgIGNvbnN0IGZvdW5kSW5kZXggPSB0aGlzLnNvcnRIZWFkZXIuZmluZEluZGV4KChmKSA9PiBmLmtleSA9PT0gc29ydC5rZXkpO1xuICAgIGlmIChmb3VuZEluZGV4ID49IDApIHtcbiAgICAgIC8vIHVwZGF0ZUZpbHRlciBmcm9tIGhlYWRlclxuICAgICAgdGhpcy5zb3J0SGVhZGVyW2ZvdW5kSW5kZXhdLmRpcmVjdGlvbiA9IHNvcnQuZGlyZWN0aW9uO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnNvcnRIZWFkZXIucHVzaCh7a2V5OiBzb3J0LmtleSwgZGlyZWN0aW9uOiBzb3J0LmRpcmVjdGlvbiwgdHlwZTogc29ydC50eXBlfSk7XG4gICAgfVxuICAgIHRoaXMuc29ydEhlYWRlciA9IHRoaXMuc29ydEhlYWRlci5maWx0ZXIoKGYpID0+IGYuZGlyZWN0aW9uICE9PSBJU3RhdGVzLk5vdGhpbmcpO1xuXG4gICAgLy8gbGFzdCBjaGFuZ2VkIC0+IGxhc3QgZmlsdGVyIGhhcyBiaWdnZXIgcHJpb3JpdHlcbiAgICAvLyBsZXQgc29ydEJ5QWxsS2V5cyA9IChhOiB7W2tleTogc3RyaW5nXTogYW55fSwgYjoge1trZXk6IHN0cmluZ106IGFueX0pOiBudW1iZXIgPT4ge1xuICAgIC8vICAgY29uc3QgYXJyOiBBcnJheTxudW1iZXI+ID0gW107XG4gICAgLy8gICB0aGlzLnNvcnRIZWFkZXIuZm9yRWFjaCgocikgPT4ge1xuICAgIC8vICAgICBjb25zdCBkID0gci5kaXJlY3Rpb24gPT09IElTdGF0ZXMuQmlnZ2VyVG9TbWFsbGVyID8gLTEgOiAxO1xuICAgIC8vICAgICBsZXQgcmVzID0gKGFbci5rZXldICsgJycpWydsb2NhbGVDb21wYXJlJ10oYltyLmtleV0gKyAnJywgJ2RlJywgeyBudW1lcmljOiByLnR5cGUgPT09ICdudW1iZXInLCBzZW5zaXRpdml0eTogXCJjYXNlXCIgfSk7XG4gICAgLy8gICAgIGFyci5wdXNoKGQgKiByZXMpO1xuICAgIC8vICAgfSk7XG4gICAgLy8gICByZXR1cm4gIGFyci5zb21lKChzKSA9PiBzID09PSAtMSkgPyAtMSA6IDE7ICAvLyBhcnJbMF07IC8vXG4gICAgLy8gfTtcblxuICAgIC8vIGxhc3QgY2hhbmdlZCAtPiBsYXN0IGZpbHRlciBoYXMgc21hbGxlciBwcmlvcml0eVxuICAgIGNvbnN0IHNvcnRCeUFsbEtleXMgPSAoYToge1trZXk6IHN0cmluZ106IGFueX0sIGI6IHtba2V5OiBzdHJpbmddOiBhbnl9KTogbnVtYmVyID0+IHtcbiAgICAgIGZvciAobGV0IGk9MDsgaSA8IHRoaXMuc29ydEhlYWRlci5sZW5ndGg7IGkrKykge1xuICAgICAgICBjb25zdCBreSA9IHRoaXMuc29ydEhlYWRlcltpXS5rZXk7XG4gICAgICAgIGNvbnN0IHR5ID0gdGhpcy5zb3J0SGVhZGVyW2ldLnR5cGU7XG4gICAgICAgIGNvbnN0IGQgPSB0aGlzLnNvcnRIZWFkZXJbaV0uZGlyZWN0aW9uID09PSBJU3RhdGVzLkJpZ2dlclRvU21hbGxlciA/IC0xIDogMTtcbiAgICAgICAgY29uc3QgcmVzID0gKGFba3ldICsgJycpWydsb2NhbGVDb21wYXJlJ10oYltreV0gKyAnJywgJ2RlJywgeyBudW1lcmljOiB0eSA9PT0gJ251bWJlcicsIHNlbnNpdGl2aXR5OiBcImNhc2VcIiB9KTtcbiAgICAgICAgaWYgKHJlcyA9PT0gLTEgfHwgcmVzID09PSAxKSB7XG4gICAgICAgICAgcmV0dXJuIHJlcyAqIGQ7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIC8vIHRoZSBzYW1lIHJldHVybiAwO1xuICAgICAgcmV0dXJuIDA7XG4gICAgfTtcblxuICAgIGlmICh0aGlzLnNvcnRIZWFkZXIubGVuZ3RoID4gMCkge1xuICAgICAgdGhpcy50YWJsZWRhdGEuc29ydCgoYToge1trZXk6IHN0cmluZ106IGFueX0sIGI6IHtba2V5OiBzdHJpbmddOiBhbnl9KSA9PiB7XG4gICAgICAgIHJldHVybiBzb3J0QnlBbGxLZXlzKGEsIGIpO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcG9zaXRpb25Sb3dzQ2hhbmdlZChkYXRhOiBBcnJheTx7W2tleTpzdHJpbmddOiBhbnl9Pik6IHZvaWQge1xuICAgIHRoaXMudGFibGVkYXRhID0gWy4uLmRhdGFdO1xuICAgIHRoaXMudGFibGVkYXRhRmlsdGVyZWQgPSBbLi4uZGF0YV07XG4gICAgdGhpcy5vbkNoYW5nZVBvc2l0aW9uUm93cy5lbWl0KGRhdGEpO1xuICB9XG5cbiAgb25IZWFkZXJTZWxlY3QoZXZlbnQ6IGFueSkge31cbiAgb25Cb2R5UGFnZShldmVudDogYW55KSB7fVxuXG4gIG9uU2VsZWN0Um93KHJvd0tleVZhbHVlc0luZGV4OiB7W2tleTogc3RyaW5nXTogYW55fSk6IHZvaWQge1xuICAgIHRoaXMuYWN0aXZhdGU/LmVtaXQocm93S2V5VmFsdWVzSW5kZXgpO1xuICB9XG4gIG9uQm9keVNjcm9sbChldmVudDogYW55KSB7fVxuICBvbkZvb3RlclBhZ2UoZXZlbnQ6IGFueSkge31cblxufVxuIiwiPGRpdiBjbGFzcz1cInJlc3BvbnNpdmVfdGFibGVcIj5cblxuICA8YXBwLXRhYmxlLWhlYWRlclxuICAgIFtjb2x1bW5zXT1cIl9pbnRlcm5hbENvbHVtbnNcIlxuICAgIFtoZWFkZXJIZWlnaHRdPVwiSEVJR0hUX0hFQURFUlwiXG4gICAgW2FsbFJvd3NTZWxlY3RlZF09XCJzZWxlY3RlZFwiXG4gICAgW3NlbGVjdGlvblR5cGVdPVwic2VsZWN0aW9uVHlwZVwiXG4gICAgW2Ryb2dnYWJsZUNvbHVtbnNdPVwiZHJvZ2dhYmxlQ29sdW1uc1wiXG4gICAgKHNlbGVjdCk9XCJvbkhlYWRlclNlbGVjdCgkZXZlbnQpXCJcbiAgICAob25JbnB1dFRleHRLZXkpPVwidXBkYXRlRmlsdGVySW5wdXQoJGV2ZW50KVwiXG4gICAgKG9uSW5wdXRTb3J0S2V5KT1cInNvcnRDb2x1bW5GaWx0ZXJJbnB1dCgkZXZlbnQpXCJcbiAgPjwvYXBwLXRhYmxlLWhlYWRlcj5cbiAgPGFwcC10YWJsZS1ib2R5XG4gICAgW2NvbmZpZ109XCJjb25maWdcIlxuICAgIFtyb3dzXT1cInRhYmxlZGF0YVwiXG4gICAgW3Njcm9sbGJhclZdPVwiY29uZmlnLnNjcm9sbFZcIlxuICAgIFtzY3JvbGxiYXJIXT1cImNvbmZpZy5zY3JvbGxIXCJcbiAgICBbbG9hZGluZ0luZGljYXRvcl09XCJjb25maWcuc2hvd0xvYWRpbmdcIlxuICAgIFtyb3dDb3VudF09XCJ0YWJsZWRhdGFGaWx0ZXJlZD8ubGVuZ3RoICsgJydcIlxuICAgIFtjb2x1bW5zXT1cIl9pbnRlcm5hbENvbHVtbnNcIlxuICAgIFtwYWdlU2l6ZV09XCJwYWdlU2l6ZVwiXG4gICAgW3Jvd0RldGFpbF09XCJyb3dEZXRhaWxcIlxuICAgIFtyb3dDbGFzc109XCJyb3dDbGFzc1wiXG4gICAgW3NlbGVjdGVkXT1cInNlbGVjdGVkXCJcbiAgICBbZHJvZ2dhYmxlUm93c109XCJkcm9nZ2FibGVSb3dzXCJcbiAgICAob25DaGFuZ2VQb3NpdGlvblJvd3MpPVwicG9zaXRpb25Sb3dzQ2hhbmdlZCgkZXZlbnQpXCJcbiAgICAocGFnZSk9XCJvbkJvZHlQYWdlKCRldmVudClcIlxuICAgIChzZWxlY3QpPVwib25TZWxlY3RSb3coJGV2ZW50KVwiXG4gICAgKHNjcm9sbCk9XCJvbkJvZHlTY3JvbGwoJGV2ZW50KVwiXG4gID48L2FwcC10YWJsZS1ib2R5PlxuICA8YXBwLXRhYmxlLWZvb3RlclxuICAgIFtyb3dDb3VudF09XCJ0YWJsZWRhdGFGaWx0ZXJlZD8ubGVuZ3RoICsgJydcIlxuICAgIFtwYWdlU2l6ZV09XCJwYWdlU2l6ZVwiXG4gICAgW2Zvb3RlckhlaWdodF09XCJIRUlHSFRfRk9PVEVSXCJcbiAgICBbdG90YWxNZXNzYWdlXT1cImNvbmZpZy5tZXNzYWdlVGFibGVOb0RhdGFcIlxuICAgIChwYWdlKT1cIm9uRm9vdGVyUGFnZSgkZXZlbnQpXCJcbiAgPjwvYXBwLXRhYmxlLWZvb3Rlcj5cblxuPCEtLSAgPGRpdiAqbmdJZj1cImNvbmZpZy5kaXNwbGF5VGFibGVOYW1lXCI+ICYjNDU7JiM0NTtOQW1lJiM0NTsmIzQ1OyA8L2Rpdj4tLT5cblxuPCEtLSAgPG1hdC1kaXZpZGVyPjwvbWF0LWRpdmlkZXI+LS0+XG48IS0tICA8ZGl2IGNsYXNzPVwicmVzcG9uc2l2ZV90YWJsZV9oZWFkZXJcIiBzdHlsZT1cImhlaWdodDoge3tIRUlHSFRfSEVBREVSfX1cIj4tLT5cbjwhLS0gICAgPG1hdC1kaXZpZGVyIHZlcnRpY2FsPVwidHJ1ZVwiPjwvbWF0LWRpdmlkZXI+LS0+XG48IS0tICAgIDxhcHAtcmVhY3RpdmUtdGFibGUtaW5wdXRzLWZpbHRlciBbYXR0cl09XCJzdHJ1Y3RcIi0tPlxuPCEtLSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKG9uSW5wdXRUZXh0S2V5KT1cInVwZGF0ZUZpbHRlcklucHV0KCRldmVudClcIi0tPlxuPCEtLSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKG9uSW5wdXRTb3J0S2V5KT1cInNvcnRDb2x1bW5GaWx0ZXJJbnB1dCgkZXZlbnQpXCItLT5cbjwhLS0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChhZGRJdGVtKT1cImFkZEl0ZW1Qcm9wLmVtaXQoKVwiLS0+XG48IS0tICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAocmVmcmVzaCk9XCJyZWZyZXNoUHJvcC5lbWl0KClcIi0tPlxuPCEtLSAgICA+LS0+XG48IS0tICAgIDwvYXBwLXJlYWN0aXZlLXRhYmxlLWlucHV0cy1maWx0ZXI+LS0+XG48IS0tICAgIDxtYXQtZGl2aWRlciB2ZXJ0aWNhbD1cInRydWVcIj48L21hdC1kaXZpZGVyPi0tPlxuPCEtLSAgPC9kaXY+LS0+XG5cbjwhLS0gIDxkaXYgY2xhc3M9XCJyZXNwb25zaXZlX3RhYmxlX2hlYWRlcl9sb2FkaW5nXCIgKm5nSWY9XCJjb25maWc/LnNob3dMb2FkaW5nICYmICFyb3dzXCI+LS0+XG48IS0tICAgIDxtYXQtZGl2aWRlcj48L21hdC1kaXZpZGVyPi0tPlxuPCEtLSAgICA8bWF0LXByb2dyZXNzLWJhciBtb2RlPVwiaW5kZXRlcm1pbmF0ZVwiPjwvbWF0LXByb2dyZXNzLWJhcj4tLT5cbjwhLS0gIDwvZGl2Pi0tPlxuXG48IS0tICA8bWF0LWRpdmlkZXI+PC9tYXQtZGl2aWRlcj4tLT5cblxuPCEtLSAgPGRpdiBjbGFzcz1cInJlc3BvbnNpdmVfdGFibGVfYm9keVwiPi0tPlxuPCEtLSAgICA8bWF0LWRpdmlkZXIgdmVydGljYWw9XCJ0cnVlXCI+PC9tYXQtZGl2aWRlcj4tLT5cbjwhLS0gICAgPGFwcC1yZWFjdGl2ZS10YWJsZS1yb3ctY2VsbCBbZGF0YV09XCJ0YWJsZWRhdGFcIi0tPlxuPCEtLSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFthdHRyXT1cInN0cnVjdFwiLS0+XG48IS0tICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKG9uQ2xpY2tSb3cpPVwiY29uZmlnLm9uU2VsZWN0Um93KCRldmVudClcIi0tPlxuPCEtLSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFtjb25maWddPVwiY29uZmlnXCItLT5cbjwhLS0gICAgPi0tPlxuPCEtLSAgICA8L2FwcC1yZWFjdGl2ZS10YWJsZS1yb3ctY2VsbD4tLT5cbjwhLS0gICAgPG1hdC1kaXZpZGVyIHZlcnRpY2FsPVwidHJ1ZVwiPjwvbWF0LWRpdmlkZXI+LS0+XG48IS0tICA8L2Rpdj4tLT5cblxuPCEtLSAgPG1hdC1kaXZpZGVyPjwvbWF0LWRpdmlkZXI+LS0+XG48IS0tICA8ZGl2ICpuZ0lmPVwiIWNvbmZpZz8uZGlzcGxheUZvb3RlciA9PT0gZmFsc2VcIiBjbGFzcz1cInJlc3BvbnNpdmVfdGFibGVfZm9vdGVyXCIgc3R5bGU9XCJoZWlnaHQ6IHt7SEVJR0hUX0ZPT1RFUn19XCI+LS0+XG48IS0tICAgIDxtYXQtZGl2aWRlciB2ZXJ0aWNhbD1cInRydWVcIj48L21hdC1kaXZpZGVyPi0tPlxuPCEtLSAgICA8YXBwLWFwcC1yZWFjdGl2ZS10YWJsZS1mb290ZXI+PC9hcHAtYXBwLXJlYWN0aXZlLXRhYmxlLWZvb3Rlcj4tLT5cbjwhLS0gICAgPG1hdC1kaXZpZGVyIHZlcnRpY2FsPVwidHJ1ZVwiIHN0eWxlPVwiaGVpZ2h0OiAxMDAlXCI+PC9tYXQtZGl2aWRlcj4tLT5cbjwhLS0gIDwvZGl2Pi0tPlxuPCEtLSAgPG1hdC1kaXZpZGVyPjwvbWF0LWRpdmlkZXI+LS0+XG48L2Rpdj5cbiJdfQ==